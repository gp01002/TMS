<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¾æŸåœ‹éš›èŠ³ç™‚ - ç‘å…¸å¼è…¿éƒ¨æŒ‰æ‘©VRæ•™å­¸ç³»çµ± (å°ˆæ¥­å¢å¼·ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        .game-container { width: 100vw; height: 100vh; position: relative; }
        
        /* æ­¡è¿ç•«é¢ */
        .welcome-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.98) 0%, rgba(118, 75, 162, 0.98) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s;
        }
        .welcome-screen.hidden { opacity: 0; pointer-events: none; }
        .welcome-content { text-align: center; color: white; padding: 40px; }
        .welcome-content h1 { font-size: 48px; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .welcome-content p { font-size: 18px; margin-bottom: 30px; line-height: 1.8; }
        
        .enter-btn {
            background: white; color: #667eea; border: none; padding: 20px 60px; 
            font-size: 24px; border-radius: 50px; cursor: pointer; font-weight: bold; 
            margin: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: all 0.3s;
        }
        .enter-btn:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 40px rgba(0,0,0,0.4); }

        /* ä»‹é¢å±¤ */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .pointer-events-auto { pointer-events: auto; }

        .status-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.95); padding: 15px 40px; border-radius: 50px;
            font-weight: bold; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; gap: 20px; align-items: center; pointer-events: auto;
        }

        /* å·¦å´ï¼šç™‚ç¨‹éšæ®µé¢æ¿ */
        .control-panel {
            position: absolute; left: 20px; top: 90px; width: 280px;
            background: rgba(255,255,255,0.98); border-radius: 20px; padding: 20px;
            max-height: calc(100vh - 360px); overflow-y: auto; pointer-events: auto;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        
        /* å³å´ï¼šæ“ä½œæŒ‡å¼•é¢æ¿ */
        .learning-panel {
            position: absolute; right: 20px; top: 90px; width: 360px;
            background: rgba(255,255,255,0.98); border-radius: 20px; padding: 25px;
            pointer-events: auto; box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-height: calc(100vh - 110px); overflow-y: auto;
        }

        .phase-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px;
            border: 2px solid #e0e0e0; background: white; border-radius: 12px; 
            cursor: pointer; text-align: left; font-weight: bold; transition: all 0.3s;
            font-size: 14px;
        }
        .phase-btn:hover { 
            background: linear-gradient(90deg, #f0f0f0, #fafafa); 
            transform: translateX(5px); 
            border-color: #667eea;
        }
        .phase-btn.active { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; border: none; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .phase-btn.completed {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; border: none;
        }

        .step-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-left: 5px solid #667eea;
            padding: 20px; margin-bottom: 20px; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .step-number { 
            font-size: 16px; color: #667eea; font-weight: bold; 
            margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
        }
        .step-desc { 
            font-size: 20px; font-weight: bold; margin-bottom: 10px; 
            color: #333; line-height: 1.4;
        }
        .step-note { 
            font-size: 14px; color: #555; line-height: 1.6; 
            background: white; padding: 10px; border-radius: 8px;
            margin-top: 10px;
        }
        
        .technique-tag {
            display: inline-block; background: #667eea; color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 12px;
            margin-top: 8px;
        }

        .progress-bar {
            width: 100%; height: 8px; background: #e0e0e0; 
            border-radius: 10px; overflow: hidden; margin: 15px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease; border-radius: 10px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; border: none; padding: 12px 25px;
            border-radius: 30px; cursor: pointer; font-size: 16px; 
            font-weight: bold; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .nav-btn:disabled { 
            background: #ccc; cursor: not-allowed; 
            box-shadow: none; transform: none;
        }

        /* æŒ‰æ‘©å‹•ä½œæ•ˆæœå±¤ */
        .massage-effect {
            position: absolute;
            width: 100px; height: 100px;
            border: 3px solid rgba(255, 215, 0, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: pulse-ring 1s infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* æ‰‹éƒ¨æ¸¸æ¨™æŒ‡ç¤º */
        .hand-cursor {
            position: fixed;
            width: 60px; height: 60px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255,255,255,0.9)"><path d="M13,14V10.5C13,9.67157 13.6716,9 14.5,9V9C15.3284,9 16,9.67157 16,10.5V12.5M16,12.5V10.5C16,9.67157 16.6716,9 17.5,9V9C18.3284,9 19,9.67157 19,10.5V12.5M16,12.5V10.5C16,9.67157 16.6716,9 17.5,9V9C18.3284,9 19,9.67157 19,10.5V12.5M12,14V5.5C12,4.67157 12.6716,4 13.5,4V4C14.3284,4 15,4.67157 15,5.5V12.5M10,14V15C10,16.6569 11.3431,18 13,18H16C17.6569,18 19,16.6569 19,15V12.5M7,11C7,10.4477 7.44772,10 8,10H9C9.55228,10 10,10.4477 10,11V14"></path></svg>') no-repeat center;
            background-size: contain;
            pointer-events: none;
            z-index: 10000;
            display: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .hand-cursor.active { display: block; }

        /* Debug é¢æ¿ */
        .debug-panel {
            position: absolute; bottom: 20px; left: 20px; 
            background: rgba(0,0,0,0.9); color: white; 
            padding: 15px; border-radius: 12px; font-size: 12px; 
            pointer-events: auto; width: 260px;
            max-height: 280px; overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .debug-section { 
            margin-bottom: 15px; border-bottom: 1px solid #444; 
            padding-bottom: 10px; 
        }
        .debug-title { 
            font-weight: bold; color: #667eea; margin-bottom: 8px; 
            font-size: 13px; 
        }
        .debug-row { 
            margin-bottom: 8px; display: flex; 
            justify-content: space-between; align-items: center; 
        }
        .debug-row label { width: 55px; font-size: 11px; }
        .debug-row input { flex: 1; margin-left: 8px; }
        .debug-row .value { 
            font-size: 10px; color: #aaa; 
            min-width: 40px; text-align: right; 
        }

        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; font-weight: bold; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            pointer-events: none; display: none;
            background: rgba(0,0,0,0.7); padding: 20px 40px;
            border-radius: 15px;
        }
        .loading.show { display: block; }

        .feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: #fff; padding: 20px 40px; 
            border-radius: 40px; font-size: 24px; opacity: 0; 
            pointer-events: none; transition: opacity 0.3s; z-index: 200;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            font-weight: bold;
        }
        
        /* æˆå°±æç¤º */
        .achievement {
            position: absolute; top: 100px; right: 20px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; padding: 15px 25px; border-radius: 15px;
            font-weight: bold; font-size: 16px;
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
            opacity: 0; pointer-events: none;
            transition: all 0.5s;
            transform: translateX(400px);
        }
        .achievement.show {
            opacity: 1; transform: translateX(0);
        }
    </style>
</head>
<body>

    <div class="game-container">
        <div id="canvas-container" style="width:100%; height:100%; background:#000;"></div>
        
        <!-- æ‰‹éƒ¨æ¸¸æ¨™ -->
        <div class="hand-cursor" id="hand-cursor"></div>

        <!-- æ­¡è¿é  -->
        <div class="welcome-screen" id="welcome-screen">
            <div class="welcome-content">
                <h1>ğŸŒ¿ è‰¾æŸåœ‹éš›èŠ³ç™‚å­¸é™¢</h1>
                <h2 style="font-size: 36px; margin-bottom: 15px;">ç‘å…¸å¼è…¿éƒ¨æŒ‰æ‘© VR æ•™å­¸ç³»çµ±</h2>
                <p style="font-size: 20px; line-height: 1.8;">
                    âœ¨ IFA åœ‹éš›èªè­‰æ¨™æº–æµç¨‹<br>
                    ğŸ¯ å°ˆæ¥­æŒ‰æ‘©æ‰‹æ³•è¨“ç·´<br>
                    ğŸ¥½ æ²‰æµ¸å¼äº’å‹•å­¸ç¿’é«”é©—
                </p>
                <button class="enter-btn" onclick="startGame()">ğŸ“ é–‹å§‹å°ˆæ¥­è¨“ç·´</button>
            </div>
        </div>

        <div class="ui-layer" id="ui-layer" style="display:none;">
            <div class="status-bar">
                <span>ğŸ« VR å°ˆæ¥­æ•™å®¤</span>
                <span id="model-status">ğŸ‘¤ è¼‰å…¥ä¸­...</span>
                <span id="progress-status">ğŸ“Š é€²åº¦: 0%</span>
            </div>

            <!-- å·¦å´ï¼šç™‚ç¨‹éšæ®µé¸æ“‡ -->
            <div class="control-panel">
                <h3 style="margin-bottom:18px; color:#667eea; font-size:18px;">ğŸ“‹ ç™‚ç¨‹éšæ®µ</h3>
                
                <button class="phase-btn" onclick="setPhase(1)" id="p1">
                    <div style="font-size:16px;">éšæ®µä¸€</div>
                    <div style="font-size:12px; color:#888; margin-top:4px;">æº–å‚™èˆ‡èµ·å§‹å®‰æ’«</div>
                </button>
                
                <button class="phase-btn" onclick="setPhase(2)" id="p2">
                    <div style="font-size:16px;">éšæ®µäºŒ</div>
                    <div style="font-size:12px; color:#888; margin-top:4px;">å·¦è…¿æŒ‰æ‘©æ“ä½œ</div>
                </button>
                
                <button class="phase-btn" onclick="setPhase(3)" id="p3">
                    <div style="font-size:16px;">éšæ®µä¸‰</div>
                    <div style="font-size:12px; color:#888; margin-top:4px;">å³è…¿æŒ‰æ‘©æ“ä½œ</div>
                </button>
                
                <button class="phase-btn" onclick="setPhase(4)" id="p4">
                    <div style="font-size:16px;">éšæ®µå››</div>
                    <div style="font-size:12px; color:#888; margin-top:4px;">çµå°¾èˆ‡å®‰æ’«</div>
                </button>
                
                <div class="progress-bar" style="margin-top:20px;">
                    <div class="progress-fill" id="progress-fill" style="width:0%;"></div>
                </div>
                <div style="text-align:center; font-size:12px; color:#888; margin-top:8px;">
                    æ•´é«”å®Œæˆåº¦: <span id="completion-percent">0%</span>
                </div>
                
                <hr style="margin: 20px 0; border:0; border-top:2px solid #e0e0e0;">
                
                <div style="font-size:13px; color:#555; font-weight:bold; margin-bottom:8px;">ğŸ”„ åˆ‡æ›æ¨¡ç‰¹å…’</div>
                <div style="display:flex; gap:8px;">
                    <button class="phase-btn" style="padding:10px; text-align:center; flex:1;" onclick="loadModel('male')">
                        ğŸ‘¨<br><span style="font-size:11px;">ç”·æ€§</span>
                    </button>
                    <button class="phase-btn" style="padding:10px; text-align:center; flex:1;" onclick="loadModel('female')">
                        ğŸ‘©<br><span style="font-size:11px;">å¥³æ€§</span>
                    </button>
                </div>
            </div>

            <!-- å³å´ï¼šè©³ç´°æ“ä½œæŒ‡å¼• -->
            <div class="learning-panel">
                <h3 style="margin-bottom:18px; color:#667eea; font-size:18px;">ğŸ“– æ“ä½œæŒ‡å¼•</h3>
                
                <div id="step-display">
                    <div class="step-card">
                        <div class="step-number" id="step-id">
                            <span>ğŸ¯</span>
                            <span>è«‹é¸æ“‡ç™‚ç¨‹éšæ®µ</span>
                        </div>
                        <div class="step-desc" id="step-text">é»é¸å·¦å´éšæ®µé–‹å§‹å°ˆæ¥­è¨“ç·´</div>
                        <div class="step-note" id="step-note">
                            ğŸ’¡ æç¤ºï¼šå¾éšæ®µä¸€é–‹å§‹ï¼Œä¾åºå®Œæˆæ‰€æœ‰æ“ä½œæ­¥é©Ÿ
                        </div>
                        <div id="technique-display"></div>
                    </div>
                </div>

                <div style="display:flex; gap:12px; margin-top:20px;">
                    <button class="nav-btn" style="background:#888; flex:1;" onclick="prevStep()">
                        â¬… ä¸Šä¸€æ­¥
                    </button>
                    <button class="nav-btn" style="flex:1;" onclick="nextStep()">
                        ä¸‹ä¸€æ­¥ â¡
                    </button>
                </div>
                
                <div style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:10px;">
                    <div style="font-size:13px; color:#555; margin-bottom:8px; font-weight:bold;">
                        ğŸ® æ“ä½œèªªæ˜
                    </div>
                    <div style="font-size:12px; color:#666; line-height:1.8;">
                        â€¢ <strong>å·¦éµæ‹–æ›³</strong>ï¼šæ—‹è½‰è¦–è§’<br>
                        â€¢ <strong>å³éµæ‹–æ›³</strong>ï¼šå¹³ç§»è¦–è§’<br>
                        â€¢ <strong>æ»¾è¼ª</strong>ï¼šç¸®æ”¾è·é›¢<br>
                        â€¢ <strong>é»æ“Šç¶ è‰²æ¨™è¨˜</strong>ï¼šåŸ·è¡ŒæŒ‰æ‘©å‹•ä½œ
                    </div>
                </div>
            </div>

            <!-- Debug å¾®èª¿é¢æ¿ -->
            <div class="debug-panel">
                <div class="debug-section">
                    <div class="debug-title">ğŸ”§ æ¨¡ç‰¹å…’ä½ç½®å¾®èª¿</div>
                    <div class="debug-row">
                        <label>å‰å¾Œ X</label>
                        <input type="range" id="range-x" min="-3" max="3" step="0.05" value="-1.2" oninput="updatePos()">
                        <span class="value" id="val-x">-1.2</span>
                    </div>
                    <div class="debug-row">
                        <label>é«˜åº¦ Y</label>
                        <input type="range" id="range-y" min="0" max="3" step="0.05" value="0.45" oninput="updatePos()">
                        <span class="value" id="val-y">0.45</span>
                    </div>
                    <div class="debug-row">
                        <label>å·¦å³ Z</label>
                        <input type="range" id="range-z" min="-3" max="3" step="0.05" value="0" oninput="updatePos()">
                        <span class="value" id="val-z">0.0</span>
                    </div>
                    <div class="debug-row">
                        <label>å¤§å°</label>
                        <input type="range" id="range-scale" min="0.5" max="2" step="0.1" value="1.0" oninput="updatePos()">
                        <span class="value" id="val-scale">1.0</span>
                    </div>
                </div>

                <div class="debug-section">
                    <div class="debug-title">ğŸ¯ ç©´ä½æ¨™è¨˜åç§»</div>
                    <div class="debug-row">
                        <label>åç§» X</label>
                        <input type="range" id="t-x" min="-1" max="1" step="0.05" value="0" oninput="updateTargetOffset()">
                        <span class="value" id="val-tx">0</span>
                    </div>
                    <div class="debug-row">
                        <label>åç§» Y</label>
                        <input type="range" id="t-y" min="-1" max="1" step="0.05" value="0" oninput="updateTargetOffset()">
                        <span class="value" id="val-ty">0</span>
                    </div>
                    <div class="debug-row">
                        <label>åç§» Z</label>
                        <input type="range" id="t-z" min="-1" max="1" step="0.05" value="0" oninput="updateTargetOffset()">
                        <span class="value" id="val-tz">0</span>
                    </div>
                </div>

                <div style="text-align: center; margin-top:10px;">
                    <button style="padding:8px 16px; cursor:pointer; border-radius:8px; background:#667eea; color:white; border:none; font-weight:bold;" onclick="resetCam()">
                        ğŸ”„ é‡ç½®è¦–è§’
                    </button>
                </div>
            </div>

            <div class="loading" id="loading-text">â³ è¼‰å…¥æ•™å­¸è³‡æºä¸­...</div>
            <div class="feedback" id="feedback-text"></div>
            <div class="achievement" id="achievement">ğŸ† éšæ®µå®Œæˆï¼</div>
        </div>
    </div>

    <script>
        const BASE_URL = "https://gp01002.github.io/TMS/";

        // å®Œæ•´çš„ç‘å…¸å¼è…¿éƒ¨æŒ‰æ‘©å­¸ç¿’è³‡æ–™åº«
        const learningData = {
            1: [
                { id: "1.1", text: "åœ¨æ¯›å·¾ä¸Šä¿¯é †è‡³å¤§è…¿", note: "è¼•æŸ”åœ°å°‡é›™æ‰‹æ”¾åœ¨æ¯›å·¾ä¸Šï¼Œå¾è†è“‹è™•å‘ä¸Šä¿¯é †è‡³å¤§è…¿ï¼Œå»ºç«‹åˆæ­¥æ¥è§¸èˆ‡ä¿¡ä»»æ„Ÿã€‚æ‰‹æ³•è¦è¼•æŸ”ã€é€£è²«ï¼Œè®“å®¢æˆ¶æ„Ÿå—åˆ°æº«æš–ã€‚", target: 'thighs', technique: "ä¿¯é †æ³• Effleurage" },
                { id: "1.2", text: "ç”±å…©å´æ»‘ä¸‹è‡³è…³åº•", note: "é›™æ‰‹æ²¿è‘—è…¿éƒ¨å…©å´ï¼Œä»¥è¼•æŸ”æµæš¢çš„å‹•ä½œå‘ä¸‹æ»‘è‡³è…³åº•ï¼Œä¿æŒé€£çºŒæ¥è§¸ã€‚é€™å€‹å‹•ä½œå¹«åŠ©å®¢æˆ¶æ”¾é¬†ä¸¦ç†Ÿæ‚‰è§¸æ„Ÿã€‚", target: 'feet', technique: "é•·æ¨æ³•" },
                { id: "1.3", text: "å°‡æ¯›å·¾æ²åœ¨é›™è…¿ä¹‹é–“", note: "å°å¿ƒåœ°å°‡æ¯›å·¾æ²èµ·ä¸¦æ”¾ç½®åœ¨é›™è…¿ä¹‹é–“ï¼Œç¢ºä¿è¦†è“‹éš±ç§éƒ¨ä½ã€‚å‹•ä½œè¦å°ˆæ¥­ã€å¾—é«”ï¼Œè®“å®¢æˆ¶æ„Ÿåˆ°å®‰å¿ƒã€‚", target: 'knees', technique: "æ¯›å·¾è™•ç†" },
                { id: "1.4", text: "é›™è…¿ç”±é˜¿åŸºé‡Œæ–¯è…±ä¸Šæ¨", note: "å¾è…³å¾Œè·Ÿçš„é˜¿åŸºé‡Œæ–¯è…±é–‹å§‹ï¼Œé›™æ‰‹åŒæ­¥å‘ä¸Šæ¨æ’«è‡³å¤§è…¿ï¼Œé€²è¡Œåˆå§‹çš„é•·æ¨æ’«é †ã€‚åŠ›é“è¦å‡å‹»ã€ç¯€å¥è¦ä¸€è‡´ã€‚", target: 'legs', technique: "é›™æ‰‹åŒæ­¥é•·æ¨" },
                { id: "1.5", text: "å°‡å³è…³è¦†è“‹", note: "ç”¨å¦ä¸€æ¢æ¯›å·¾æˆ–å¸ƒå·¾è¼•æŸ”åœ°è¦†è“‹å³è…¿ï¼Œç¢ºä¿ä¿æš–ã€‚é€™è¡¨ç¤ºæ¥ä¸‹ä¾†å°‡å°ˆæ³¨æ–¼å·¦è…¿çš„æŒ‰æ‘©æ“ä½œã€‚", target: 'right_leg', technique: "ä¿æš–è™•ç†" },
                { id: "1.6", text: "ä¸Šæ²¹", note: "å–é©é‡æŒ‰æ‘©æ²¹æ–¼é›™æ‰‹æŒå¿ƒï¼Œæ“ç†±å¾Œæº–å‚™æ–½ä½œã€‚æ²¹é‡è¦é©ä¸­ï¼Œä¸å¯éå¤šæˆ–éå°‘ã€‚æ‰‹çš„æº«åº¦ä¹Ÿå¾ˆé‡è¦ã€‚", target: 'hands', technique: "æ²¹å“æº–å‚™" },
                { id: "1.7", text: "å¤§å®‰æ’«", note: "é›™æ‰‹æ”¾åœ¨è…³åº•ï¼Œåœç•™ç‰‡åˆ»ï¼Œæ·±å‘¼å¸ï¼Œå»ºç«‹èˆ‡å®¢æˆ¶çš„èƒ½é‡é€£çµã€‚é€™æ˜¯ç™‚ç¨‹é–‹å§‹çš„å„€å¼æ€§å‹•ä½œï¼Œéå¸¸é‡è¦ã€‚", target: 'feet', technique: "å®‰æ’«æ¥è§¸æ³•" }
            ],
            2: [
                { id: "2.1", text: "å·¦è…¿ï¼šæ‹‡æŒ‡ä¸¦æ’é•·æ¨è‡³å¤§è…¿", note: "é›™æ‰‹æ‹‡æŒ‡ä¸¦æ’ï¼Œå¾è…³è¸è™•é–‹å§‹ï¼Œå‘ä¸Šé•·æ¨è‡³å¤§è…¿æ ¹éƒ¨ã€‚æ–½åŠ›è¦å‡å‹»ï¼Œä¿æŒå¹³ç©©çš„ç¯€å¥ï¼Œæ„Ÿå—è‚Œè‚‰çš„å¼µåŠ›ã€‚", target: 'left_leg_long', technique: "æ‹‡æŒ‡ä¸¦æ’é•·æ¨æ³•" },
                { id: "2.2", text: "ç”±å…©å´å›åŒ…", note: "é•·æ¨è‡³é ‚ç«¯å¾Œï¼Œé›™æ‰‹åˆ†åˆ¥æ²¿è…¿éƒ¨å…©å´è¼•æŸ”å›æ’«è‡³èµ·å§‹ä½ç½®ã€‚é€™æ˜¯å›ç¨‹å‹•ä½œï¼ŒåŠ›é“è¦è¼•æ–¼ä¸Šæ¨æ™‚ã€‚", target: 'left_leg', technique: "å›ç¨‹æ’«é †" },
                { id: "2.3", text: "æ’¥ææŠ€å·§", note: "å¾è…³è¸é–‹å§‹ï¼Œåˆ†æ®µå‘ä¸Šï¼Œé›™æ‰‹äº¤æ›¿å‘å…©å´ææ‹‰å°è…¿è‚Œè‚‰ï¼ˆè…“è…¸è‚Œï¼‰ï¼Œå¦‚åŒæ‰éºµåœ˜èˆ¬ã€‚é€™èƒ½æ·±å±¤æ”¾é¬†è‚Œè‚‰çµ„ç¹”ã€‚", target: 'left_calf', technique: "æ’¥ææ³• Petrissage" },
                { id: "2.4", text: "å¤§è…¿å…§å¤–å´æ“ä½œ", note: "å…ˆæ“ä½œå¤§è…¿å…§å´ï¼Œå†æ“ä½œå¤–å´ã€‚ç”¨æŒæ ¹æˆ–æ‹‡æŒ‡æ–½å£“ï¼Œæ²¿è‘—è‚Œè‚‰ç´‹ç†æ¨æ’«ã€‚æ³¨æ„å…§å´è‚Œè‚‰è¼ƒæ•æ„Ÿï¼ŒåŠ›é“è¦é©ä¸­ã€‚", target: 'left_thigh', technique: "åˆ†å€æ¨æ’«æ³•" },
                { id: "2.5", text: "é›™æ‰‹äº¤æ›¿å‘ä¸Šæ’«é †", note: "é›™æ‰‹äº¤æ›¿ã€é€£çºŒä¸æ–·åœ°å¾è…³è¸å‘ä¸Šæ¨æ’«è‡³å¤§è…¿ï¼Œå¦‚åŒæµ·æµªèˆ¬é€£ç¶¿ä¸çµ•ã€‚ä¿æŒæµæš¢çš„ç¯€å¥æ„Ÿã€‚", target: 'left_leg_long', technique: "äº¤æ›¿é•·æ¨æ³•" },
                { id: "2.6", text: "å°è…¿å‘ä¸Šé•·æ¨è‡³å§”ä¸­ç©´", note: "å¾è…³è¸é–‹å§‹ï¼Œå‘ä¸Šæ¨è‡³è†è“‹å¾Œæ–¹çš„å§”ä¸­ç©´ã€‚æ³¨æ„è†çª©è™•åŠ›é“è¦æ¸›è¼•ï¼Œé¿å…é€ æˆä¸é©ã€‚", target: 'left_calf', technique: "ç©´ä½å®šä½é•·æ¨" },
                { id: "2.7", text: "å°è…¿åˆ†ä¸‰ç­‰ä»½æ“ä½œ", note: "å°‡å°è…¿æƒ³åƒåˆ†ç‚ºå…§ã€ä¸­ã€å¤–ä¸‰ç­‰ä»½ã€‚ä¾åºæ“ä½œï¼šå…§â†’ä¸­â†’å¤–ï¼Œç„¶å¾Œåå‘ï¼šå¤–â†’ä¸­â†’å…§ï¼Œå®Œæˆä¸€å€‹ä¾†å›å…±ä¸‰æ¬¡æ¨æ’«ã€‚", target: 'left_calf', technique: "ä¸‰ç­‰ä»½åˆ†å€æ³•" },
                { id: "2.8", text: "æŠ¬è…³ 90 åº¦ï¼Œä¸€æ‰‹æ‰˜è…³ç›¤", note: "è¼•æŸ”åœ°å°‡å®¢æˆ¶å·¦è…³æŠ¬èµ·è‡³ç´„90åº¦ï¼Œä¸€æ‰‹æ‰˜ä½è…³æŒï¼Œæº–å‚™é€²è¡Œè…³åº•æŒ‰æ‘©ã€‚å‹•ä½œè¦ç©©å®šã€æ”¯æ’è¦å……è¶³ã€‚", target: 'left_foot_lift', technique: "æŠ¬è…³æº–å‚™" }
            ],
            3: [
                { id: "3.1", text: "å³è…¿ï¼šæ‹‡æŒ‡ä¸¦æ’é•·æ¨å¤§è…¿", note: "åˆ‡æ›è‡³å³è…¿ï¼Œé‡è¤‡å·¦è…¿çš„åŸºç¤å‹•ä½œã€‚å¾è…³è¸è™•é›™æ‰‹æ‹‡æŒ‡ä¸¦æ’ï¼Œå‡å‹»å‘ä¸Šæ¨æ’«è‡³å¤§è…¿æ ¹éƒ¨ã€‚", target: 'right_leg_long', technique: "æ‹‡æŒ‡ä¸¦æ’é•·æ¨æ³•" },
                { id: "3.2", text: "ç”±å…©å´å›åŒ…", note: "æ²¿è‘—å³è…¿å…©å´è¼•æŸ”å›æ’«è‡³èµ·å§‹ä½ç½®ï¼Œä¿æŒèˆ‡å®¢æˆ¶çš„æŒçºŒæ¥è§¸ï¼Œä¸è¦ä¸­æ–·ã€‚", target: 'right_leg', technique: "å›ç¨‹æ’«é †" },
                { id: "3.3", text: "æ’¥æç”±ä¸‹è‡³ä¸Š", note: "å¾è…³è¸é–‹å§‹ï¼Œåˆ†æ®µå‘ä¸Šï¼Œé›™æ‰‹äº¤æ›¿å‘å…©å´ææ‹‰å³å°è…¿è‚Œè‚‰ã€‚æ‰‹æ³•è¦æ·±å…¥ä½†ä¸ç²—æš´ã€‚", target: 'right_calf', technique: "æ’¥ææ³•" },
                { id: "3.4", text: "â˜… S å‹æŠ“æ", note: "é€™æ˜¯å³è…¿çš„ç‰¹æ®ŠæŠ€å·§ï¼é›™æ‰‹å‘ˆSå‹è»Œè·¡ï¼Œäº¤æ›¿æŠ“æå°è…¿è‚Œè‚‰ï¼Œå¾ä¸‹å¾€ä¸Šæ¨é€²ã€‚åŠ›é“è¦é©ä¸­ï¼Œç¯€å¥è¦æ˜ç¢ºã€‚é€™æ˜¯è€ƒè©¦é‡é»æŠ€å·§ï¼", target: 'right_calf', technique: "Så‹æŠ“ææ³• (é‡é»)" },
                { id: "3.5", text: "å¤§è…¿å…§å¤–å´æ“ä½œ", note: "å…ˆå…§å´å¾Œå¤–å´ï¼Œç”¨æŒæ ¹æˆ–æ‹‡æŒ‡æ²¿è‚Œè‚‰ç´‹ç†æ¨æ’«ã€‚å³è…¿çš„æ“ä½œè¦èˆ‡å·¦è…¿ä¿æŒä¸€è‡´æ€§ã€‚", target: 'right_thigh', technique: "åˆ†å€æ¨æ’«æ³•" },
                { id: "3.6", text: "é›™æ‰‹äº¤æ›¿å‘ä¸Šæ’«é †", note: "äº¤æ›¿æ‰‹æ³•é€£çºŒå‘ä¸Šæ¨æ’«ï¼Œä¿æŒæµæš¢ç¯€å¥ï¼Œè®“å®¢æˆ¶æ„Ÿå—åˆ°é€£è²«çš„èˆ’é©æ„Ÿã€‚", target: 'right_leg_long', technique: "äº¤æ›¿é•·æ¨æ³•" },
                { id: "3.7", text: "å°è…¿å‘ä¸Šé•·æ¨è‡³å§”ä¸­ç©´", note: "å‘ä¸Šæ¨è‡³è†è“‹å¾Œæ–¹å§”ä¸­ç©´ï¼Œæ³¨æ„åŠ›é“æ§åˆ¶ï¼Œè†çª©è™•è¦ç‰¹åˆ¥è¼•æŸ”ã€‚", target: 'right_calf', technique: "ç©´ä½å®šä½é•·æ¨" },
                { id: "3.8", text: "å°è…¿åˆ†ä¸‰ç­‰ä»½æ“ä½œ", note: "å…§â†’ä¸­â†’å¤–ï¼Œå†å¤–â†’ä¸­â†’å…§ï¼Œå®Œæˆä¸‰æ¬¡å®Œæ•´æ¨æ’«ã€‚ä¿æŒæ¯ä¸€æ®µçš„åŠ›é“ä¸€è‡´ã€‚", target: 'right_calf', technique: "ä¸‰ç­‰ä»½åˆ†å€æ³•" },
                { id: "3.9", text: "æŠ¬è…³ 90 åº¦", note: "ä¸€æ‰‹æ‰˜ä½å³è…³è…³ç›¤ï¼Œæº–å‚™é€²è¡Œè…³åº•æŒ‰æ‘©ã€‚æ”¯æ’è¦ç©©å›ºã€è§’åº¦è¦èˆ’é©ã€‚", target: 'right_foot_lift', technique: "æŠ¬è…³æº–å‚™" },
                { id: "3.10", text: "ç”±æ¹§æ³‰ç©´é †æ™‚é‡ç•«åœˆ", note: "ç”¨æ‹‡æŒ‡åœ¨è…³åº•çš„æ¹§æ³‰ç©´è™•ï¼Œé †æ™‚é‡ç•«åœˆæŒ‰æ‘©ï¼Œç¶“éè¶³å¼“å›åˆ°æ¹§æ³‰ç©´ã€‚åŠ›é“è¦æ·±å…¥ä½†ä¸åˆºç—›ã€‚", target: 'right_foot', technique: "è¶³åº•ç©´ä½æŒ‰æ‘©" },
                { id: "3.11", text: "åŠæ¡æ‹³è…³è·Ÿå¾€è…³è¶¾æ»‘å‹•", note: "ä»¥åŠæ¡æ‹³çš„æ–¹å¼ï¼Œå¾è…³è·Ÿå‘è…³è¶¾æ–¹å‘æ»‘å‹•æŒ‰å£“ã€‚é€™èƒ½æœ‰æ•ˆæ”¾é¬†è¶³åº•ç­‹è†œã€‚", target: 'right_foot', technique: "è¶³åº•æ·±å±¤æŒ‰æ‘©" },
                { id: "3.12", text: "ä¸€æ‰‹æ”¾ç½®è…³æŒå¿ƒï¼Œè‚©è†€æ”¾é¬†", note: "ä¸€æ‰‹æŒçºŒæŒ‰å£“è…³æŒå¿ƒï¼Œä¿æŒè‡ªå·±çš„å§¿å‹¢æ­£ç¢ºã€è‚©è†€æ”¾é¬†ã€‚é€™æ˜¯æª¢æŸ¥æ–½è¡“è€…å§¿å‹¢çš„æ™‚åˆ»ã€‚", target: 'right_foot', technique: "æŒçºŒæŒ‰å£“" },
                { id: "3.13", text: "æ¡åç§’", note: "ç”¨é©ç•¶åŠ›é“æŒçºŒæŒ‰å£“è…³æŒå¿ƒåç§’é˜ï¼Œçµ¦äºˆå®¢æˆ¶å®‰å®šæ„Ÿèˆ‡æ·±å±¤æ”¾é¬†ã€‚é€™æ˜¯é‡è¦çš„æ”¶å°¾å‹•ä½œã€‚", target: 'right_foot', technique: "å®šé»æŒå£“æ³•" }
            ],
            4: [
                { id: "4.1", text: "æ¯›å·¾æ²å›ä¸­é–“", note: "è¼•æŸ”åœ°å°‡ä¹‹å‰åˆ†é–‹çš„æ¯›å·¾é‡æ–°æ²å›é›™è…¿ä¸­é–“çš„ä½ç½®ï¼Œæº–å‚™é€²è¡ŒçµæŸå‹•ä½œã€‚", target: 'knees', technique: "æ¯›å·¾å¾©ä½" },
                { id: "4.2", text: "å¤§å®‰æ’«", note: "é€²è¡Œæœ€çµ‚çš„å»£æ³›å®‰æ’«ï¼Œé›™æ‰‹åŒæ™‚æ’«é †é›™è…¿ï¼Œå¾å¤§è…¿è‡³è…³è¸ï¼Œæ¶µè“‹æ•´å€‹æŒ‰æ‘©å€åŸŸã€‚é€™æ˜¯ç™‚ç¨‹çš„ç¸½çµå‹•ä½œã€‚", target: 'legs', technique: "ç¸½çµæ€§å®‰æ’«æ³•" },
                { id: "4.3", text: "å…©æ‰‹æ”¾åœ¨è…³åº•åœç•™", note: "é›™æ‰‹è¼•æ”¾åœ¨é›™è…³åº•éƒ¨ï¼Œåœç•™ç‰‡åˆ»ï¼Œæ·±å‘¼å¸ï¼Œæ„Ÿè¬é€™æ¬¡ç™‚ç¨‹ã€‚é€™æ˜¯èƒ½é‡æ”¶å°¾çš„å„€å¼ã€‚", target: 'feet', technique: "èƒ½é‡æ”¶å°¾" },
                { id: "4.4", text: "è“‹ä¸Šæ¯›å·¾çµæŸ", note: "ç”¨æ¯›å·¾å®Œæ•´è¦†è“‹é›™è…¿ï¼Œå‹•ä½œè¦è¼•æŸ”ã€å°ˆæ¥­ã€‚é€™å®£å‘Šæ•´å€‹ç™‚ç¨‹çš„æ­£å¼çµæŸï¼Œè®“å®¢æˆ¶éœèººç‰‡åˆ»ã€‚", target: 'legs', technique: "çµæŸè¦†è“‹" }
            ]
        };

        let scene, camera, renderer, controls, model;
        let currentPhase = 1;
        let currentStepIndex = 0;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let targets = [];
        let completedSteps = new Set();
        let phaseCompletion = {1: 0, 2: 0, 3: 0, 4: 0};
        
        // ç©´ä½é»æ‰‹å‹•åç§»é‡
        let targetAdjust = {x: 0, y: 0, z: 0};
        
        // æ‰‹éƒ¨æ¸¸æ¨™
        let handCursor;

        function startGame() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('ui-layer').style.display = 'block';
            handCursor = document.getElementById('hand-cursor');
            setTimeout(initThreeJS, 100);
        }

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            
            // åœ°é¢æ ¼ç·š
            const grid = new THREE.GridHelper(20, 20, 0x888888, 0x444444);
            scene.add(grid);

            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(2, 3, 3);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 15;

            // ç…§æ˜ç³»çµ±
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('click', onCanvasClick);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.setAnimationLoop(animate);

            loadRoom();
            loadModel('male');
            setPhase(1);
        }

        function loadRoom() {
            const loader = new THREE.GLTFLoader();
            loader.load(BASE_URL + 'A01.glb', (gltf) => {
                const room = gltf.scene;
                room.scale.set(20, 20, 20);
                scene.add(room);
            }, undefined, (error) => {
                console.error('è¼‰å…¥æˆ¿é–“å¤±æ•—:', error);
            });
        }

        function loadModel(type) {
            if (model) scene.remove(model);
            
            document.getElementById('loading-text').classList.add('show');
            document.getElementById('model-status').innerText = 'ğŸ‘¤ è¼‰å…¥æ¨¡ç‰¹å…’ä¸­...';
            
            const url = BASE_URL + (type === 'male' ? 'B01.glb' : 'B02.glb');

            const loader = new THREE.GLTFLoader();
            loader.load(url, (gltf) => {
                model = gltf.scene;
                
                // è¨­å®šæ¨¡ç‰¹å…’ä½ç½®å’Œæ—‹è½‰
                updatePos(); 
                model.rotation.set(-Math.PI/2, 0, Math.PI/2);
                
                scene.add(model);
                
                document.getElementById('model-status').innerText = 'âœ… æ¨¡ç‰¹å…’å·²å°±ä½';
                document.getElementById('model-status').style.background = '#d4edda';
                document.getElementById('model-status').style.color = '#155724';
                
                updateTargets();
                document.getElementById('loading-text').classList.remove('show');
            }, undefined, (error) => {
                console.error('è¼‰å…¥æ¨¡ç‰¹å…’å¤±æ•—:', error);
                document.getElementById('model-status').innerText = 'âŒ è¼‰å…¥å¤±æ•—';
                document.getElementById('loading-text').classList.remove('show');
            });
        }

        function updatePos() {
            if (model) {
                const x = parseFloat(document.getElementById('range-x').value);
                const y = parseFloat(document.getElementById('range-y').value);
                const z = parseFloat(document.getElementById('range-z').value);
                const scale = parseFloat(document.getElementById('range-scale').value);
                
                model.position.set(x, y, z);
                model.scale.set(scale, scale, scale);
                
                // æ›´æ–°é¡¯ç¤ºæ•¸å€¼
                document.getElementById('val-x').innerText = x.toFixed(2);
                document.getElementById('val-y').innerText = y.toFixed(2);
                document.getElementById('val-z').innerText = z.toFixed(2);
                document.getElementById('val-scale').innerText = scale.toFixed(1);
                
                updateTargets();
            }
        }

        function updateTargetOffset() {
             targetAdjust.x = parseFloat(document.getElementById('t-x').value);
             targetAdjust.y = parseFloat(document.getElementById('t-y').value);
             targetAdjust.z = parseFloat(document.getElementById('t-z').value);
             
             document.getElementById('val-tx').innerText = targetAdjust.x.toFixed(2);
             document.getElementById('val-ty').innerText = targetAdjust.y.toFixed(2);
             document.getElementById('val-tz').innerText = targetAdjust.z.toFixed(2);
             
             updateTargets();
        }

        function updateTargets() {
            if (!model) return;
            
            // æ¸…é™¤èˆŠçš„æ¨™è¨˜
            if (targets.length > 0) {
                targets.forEach(t => scene.remove(t));
            }
            targets = [];

            const currentStep = learningData[currentPhase]?.[currentStepIndex];
            if (!currentStep) return;
            
            const targetType = currentStep.target || 'legs';
            const basePos = model.position;
            let positions = [];

            // æ ¹æ“šä¸åŒéƒ¨ä½è¨­å®šæ¨™è¨˜ä½ç½®
            switch(targetType) {
                case 'left_leg': 
                case 'left_leg_long':
                    positions = [
                        {x: 0.3, y: 0.3, z: 0.25},  // å°è…¿
                        {x: 0.7, y: 0.3, z: 0.25}   // å¤§è…¿
                    ]; 
                    break;
                case 'right_leg': 
                case 'right_leg_long':
                    positions = [
                        {x: 0.3, y: 0.3, z: -0.25},
                        {x: 0.7, y: 0.3, z: -0.25}
                    ]; 
                    break;
                case 'left_thigh':
                    positions = [{x: 0.15, y: 0.3, z: 0.25}]; 
                    break;
                case 'right_thigh':
                    positions = [{x: 0.15, y: 0.3, z: -0.25}]; 
                    break;
                case 'left_calf':
                    positions = [{x: 0.65, y: 0.3, z: 0.25}]; 
                    break;
                case 'right_calf':
                    positions = [{x: 0.65, y: 0.3, z: -0.25}]; 
                    break;
                case 'feet':
                    positions = [
                        {x: 1.0, y: 0.25, z: 0.25},
                        {x: 1.0, y: 0.25, z: -0.25}
                    ]; 
                    break;
                case 'left_foot_lift':
                    positions = [{x: 1.0, y: 0.7, z: 0.25}]; 
                    break; 
                case 'right_foot_lift':
                    positions = [{x: 1.0, y: 0.7, z: -0.25}]; 
                    break;
                case 'right_foot':
                    positions = [{x: 1.0, y: 0.25, z: -0.25}]; 
                    break;
                case 'knees':
                    positions = [{x: 0.5, y: 0.3, z: 0}]; 
                    break;
                case 'thighs':
                    positions = [
                        {x: 0.2, y: 0.3, z: 0.25},
                        {x: 0.2, y: 0.3, z: -0.25}
                    ];
                    break;
                case 'hands':
                    positions = [{x: 0.5, y: 0.6, z: 0}]; 
                    break;
                case 'legs':
                    positions = [
                        {x: 0.4, y: 0.3, z: 0.25},
                        {x: 0.4, y: 0.3, z: -0.25}
                    ];
                    break;
                default: 
                    positions = [{x: 0.5, y: 0.3, z: 0}];
            }

            // å‰µå»ºæ¨™è¨˜çƒé«”
            const geo = new THREE.SphereGeometry(0.12, 16, 16);
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.6 
            });

            positions.forEach(p => {
                const ball = new THREE.Mesh(geo, mat.clone());
                
                // åº§æ¨™è¨ˆç®—ï¼šæ¨¡å‹ä½ç½® + é è¨­åç§» + æ‰‹å‹•æ ¡æ­£åç§»
                ball.position.set(
                    basePos.x + p.x + targetAdjust.x, 
                    basePos.y + p.y + targetAdjust.y, 
                    basePos.z + p.z + targetAdjust.z
                );
                
                // è„ˆå‹•å‹•ç•«
                gsap.to(ball.material, { 
                    opacity: 0.2, 
                    duration: 0.8, 
                    yoyo: true, 
                    repeat: -1 
                });
                gsap.to(ball.scale, {
                    x: 1.3,
                    y: 1.3,
                    z: 1.3,
                    duration: 0.8,
                    yoyo: true,
                    repeat: -1
                });
                
                scene.add(ball);
                targets.push(ball);
            });
        }

        function setPhase(p) {
            currentPhase = p;
            currentStepIndex = 0;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.phase-btn').forEach((b, i) => {
                b.classList.remove('active');
                if (phaseCompletion[i + 1] === 100) {
                    b.classList.add('completed');
                } else {
                    b.classList.remove('completed');
                }
            });
            document.getElementById('p' + p).classList.add('active');
            
            updateStepDisplay();
            updateProgress();
        }

        function nextStep() {
            const currentPhaseSteps = learningData[currentPhase];
            if (currentStepIndex < currentPhaseSteps.length - 1) {
                currentStepIndex++;
                updateStepDisplay();
            } else {
                // éšæ®µå®Œæˆ
                phaseCompletion[currentPhase] = 100;
                updateProgress();
                showAchievement(`ğŸ‰ éšæ®µ${currentPhase}å®Œæˆï¼`);
                
                if (currentPhase < 4) {
                    showFeedback(`éšæ®µ${currentPhase}å®Œæˆï¼è«‹é¸æ“‡ä¸‹ä¸€éšæ®µ`, true);
                } else {
                    showFeedback("ğŸ† æ­å–œï¼å®Œæˆå…¨éƒ¨ç™‚ç¨‹è¨“ç·´ï¼", true);
                }
            }
        }

        function prevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            const step = learningData[currentPhase][currentStepIndex];
            if (!step) return;
            
            document.getElementById('step-id').innerHTML = `
                <span>ğŸ¯</span>
                <span>STEP ${step.id}</span>
            `;
            document.getElementById('step-text').innerText = step.text;
            document.getElementById('step-note').innerText = `ğŸ’¡ ${step.note}`;
            
            // é¡¯ç¤ºæ‰‹æ³•æ¨™ç±¤
            if (step.technique) {
                document.getElementById('technique-display').innerHTML = `
                    <div class="technique-tag">âœ¨ ${step.technique}</div>
                `;
            } else {
                document.getElementById('technique-display').innerHTML = '';
            }
            
            updateTargets(); 
            
            // è¨ˆç®—ç•¶å‰éšæ®µé€²åº¦
            const totalSteps = learningData[currentPhase].length;
            const progress = Math.round((currentStepIndex / (totalSteps - 1)) * 100);
            phaseCompletion[currentPhase] = progress;
            updateProgress();
        }

        function updateProgress() {
            // è¨ˆç®—ç¸½é«”å®Œæˆåº¦
            const totalCompletion = Object.values(phaseCompletion).reduce((a, b) => a + b, 0) / 4;
            document.getElementById('completion-percent').innerText = Math.round(totalCompletion) + '%';
            document.getElementById('progress-fill').style.width = totalCompletion + '%';
            document.getElementById('progress-status').innerText = `ğŸ“Š é€²åº¦: ${Math.round(totalCompletion)}%`;
        }

        function onMouseMove(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(targets);
            if (intersects.length > 0) {
                handCursor.classList.add('active');
                handCursor.style.left = e.clientX + 'px';
                handCursor.style.top = e.clientY + 'px';
                document.body.style.cursor = 'pointer';
            } else {
                handCursor.classList.remove('active');
                document.body.style.cursor = 'default';
            }
        }

        function onCanvasClick(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(targets);
            if (intersects.length > 0) {
                const pt = intersects[0].object.position;
                playMassageEffect(pt);
                
                const step = learningData[currentPhase][currentStepIndex];
                showFeedback(`âœ… å®Œæˆ: ${step.text}`, true);
                
                // æ¨™è¨˜ç‚ºå·²å®Œæˆ
                const stepKey = `${currentPhase}-${currentStepIndex}`;
                completedSteps.add(stepKey);
                
                // è‡ªå‹•å‰é€²åˆ°ä¸‹ä¸€æ­¥
                setTimeout(() => {
                    nextStep();
                }, 1500);
            }
        }

        function playMassageEffect(pos) {
            // å‰µå»ºå¤šå±¤æ•ˆæœ
            
            // 1. å…‰ç’°æ“´æ•£
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(0.08, 0.15, 32),
                new THREE.MeshBasicMaterial({ 
                    color: 0xffff00, 
                    side: THREE.DoubleSide,
                    transparent: true
                })
            );
            ring.position.copy(pos);
            ring.rotation.x = -Math.PI/2;
            scene.add(ring);
            
            gsap.to(ring.scale, {
                x: 4, 
                y: 4, 
                duration: 1.2, 
                ease: "power2.out"
            });
            gsap.to(ring.material, {
                opacity: 0, 
                duration: 1.2,
                onComplete: () => scene.remove(ring)
            });
            
            // 2. ç²’å­çˆ†ç™¼æ•ˆæœ
            for (let i = 0; i < 8; i++) {
                const particle = new THREE.Mesh(
                    new THREE.SphereGeometry(0.03, 8, 8),
                    new THREE.MeshBasicMaterial({ 
                        color: 0x00ff88,
                        transparent: true
                    })
                );
                particle.position.copy(pos);
                scene.add(particle);
                
                const angle = (Math.PI * 2 / 8) * i;
                const distance = 0.5;
                gsap.to(particle.position, {
                    x: pos.x + Math.cos(angle) * distance,
                    z: pos.z + Math.sin(angle) * distance,
                    y: pos.y + 0.3,
                    duration: 0.8,
                    ease: "power2.out"
                });
                gsap.to(particle.material, {
                    opacity: 0,
                    duration: 0.8,
                    onComplete: () => scene.remove(particle)
                });
            }
            
            // 3. ä¸­å¿ƒå…‰é»
            const centerLight = new THREE.Mesh(
                new THREE.SphereGeometry(0.15, 16, 16),
                new THREE.MeshBasicMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8
                })
            );
            centerLight.position.copy(pos);
            scene.add(centerLight);
            
            gsap.to(centerLight.scale, {
                x: 0.1,
                y: 0.1,
                z: 0.1,
                duration: 0.6
            });
            gsap.to(centerLight.material, {
                opacity: 0,
                duration: 0.6,
                onComplete: () => scene.remove(centerLight)
            });
        }

        function showFeedback(msg, isSuccess) {
            const el = document.getElementById('feedback-text');
            el.innerText = msg;
            el.style.opacity = 1;
            el.style.background = isSuccess ? 
                "linear-gradient(135deg, rgba(17, 153, 142, 0.95), rgba(56, 239, 125, 0.95))" : 
                "rgba(0,0,0,0.85)";
            
            clearTimeout(window.fbTimer);
            window.fbTimer = setTimeout(() => { 
                el.style.opacity = 0; 
            }, 2000);
        }

        function showAchievement(msg) {
            const el = document.getElementById('achievement');
            el.innerText = msg;
            el.classList.add('show');
            
            setTimeout(() => {
                el.classList.remove('show');
            }, 3000);
        }

        function resetCam() { 
            controls.reset();
            camera.position.set(2, 3, 3);
            camera.lookAt(0, 0, 0);
        }
        
        function onWindowResize() {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        function animate() {
            if (controls) controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
