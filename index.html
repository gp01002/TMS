<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¾æŸåœ‹éš›èŠ³ç™‚ - VRè™›æ“¬æŒ‰æ‘©æ²»ç™‚ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            color: white;
            max-width: 800px;
            padding: 40px;
        }

        .welcome-content h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .welcome-content p {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .enter-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 20px 60px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin: 10px;
        }

        .enter-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .enter-btn.vr-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .status-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .control-panel {
            position: absolute;
            left: 20px;
            top: 100px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .model-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .model-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .model-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .model-card.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .model-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .technique-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .technique-btn {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border: none;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .technique-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .technique-btn.active {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            box-shadow: 0 0 20px rgba(250, 112, 154, 0.5);
        }

        .technique-icon {
            font-size: 24px;
        }

        .technique-info {
            flex: 1;
        }

        .technique-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .technique-desc {
            font-size: 11px;
            opacity: 0.8;
        }

        .info-panel {
            position: absolute;
            right: 20px;
            top: 100px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .patient-info {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-item {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .toolbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tool-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .tool-btn.vr-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            transition: opacity 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
        }

        .treatment-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 24px;
            font-weight: bold;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .treatment-effect.show {
            opacity: 1;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .interaction-hint {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 90;
            animation: fadeInOut 3s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
            display: none;
        }

        .crosshair.active {
            display: block;
            background: rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="welcome-screen" id="welcome-screen">
            <div class="welcome-content">
                <h1>ğŸ¥½ VRè™›æ“¬æŒ‰æ‘©æ²»ç™‚ç³»çµ±</h1>
                <p>
                    æ­¡è¿ä¾†åˆ°è‰¾æŸåœ‹éš›çš„VRæ²»ç™‚ç©ºé–“ï¼<br>
                    é«”é©—çœŸå¯¦çš„3Dé†«ç™‚ç’°å¢ƒï¼Œé€²è¡Œå°ˆæ¥­æŒ‰æ‘©è¨“ç·´ã€‚
                </p>
                <p>
                    ğŸ–±ï¸ <strong>æ¡Œé¢æ¨¡å¼</strong>ï¼šæ»‘é¼ æ‹–æ›³ç§»å‹•è¦–è§’<br>
                    ğŸ¥½ <strong>VRæ¨¡å¼</strong>ï¼šæ²‰æµ¸å¼è™›æ“¬å¯¦å¢ƒé«”é©—<br>
                    ğŸ‘† <strong>äº’å‹•æ“ä½œ</strong>ï¼šé»æ“Šæ¨¡ç‰¹å…’èº«é«”é€²è¡Œæ²»ç™‚
                </p>
                <div>
                    <button class="enter-btn" onclick="enterSpace(false)">
                        ğŸ–¥ï¸ æ¡Œé¢æ¨¡å¼
                    </button>
                    <button class="enter-btn vr-btn" onclick="enterSpace(true)">
                        ğŸ¥½ VRæ¨¡å¼
                    </button>
                </div>
            </div>
        </div>

        <div id="canvas-container">
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
                <div class="loading-text" id="loading-text">è¼‰å…¥æ²»ç™‚ç©ºé–“ä¸­...</div>
            </div>
            <div class="crosshair" id="crosshair"></div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-icon">ğŸ¥</span>
                <span>è‰¾æŸåœ‹éš›é†«ç™‚ç©ºé–“</span>
            </div>
            <div class="status-item">
                <span class="status-icon">ğŸ‘¤</span>
                <span id="current-patient">æœªé¸æ“‡æ¨¡ç‰¹å…’</span>
            </div>
            <div class="status-item">
                <span class="status-icon">ğŸ–ï¸</span>
                <span id="current-technique">å¾…é¸æ“‡æ‰‹æ³•</span>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-section">
                <div class="panel-title">ğŸ¥ æ²»ç™‚ç©ºé–“</div>
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 14px; margin-bottom: 5px;">ç•¶å‰ç©ºé–“</div>
                    <div style="font-size: 20px; font-weight: bold;">A01 é†«ç™‚å®¤</div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">ğŸ‘¥ é¸æ“‡æ¨¡ç‰¹å…’</div>
                <div class="model-selector">
                    <div class="model-card" onclick="selectModel('male')" id="model-male">
                        <div class="model-icon">ğŸ‘¨</div>
                        <div class="model-name">ç”·æ€§æ¨¡ç‰¹å…’</div>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">B01</div>
                    </div>
                    <div class="model-card" onclick="selectModel('female')" id="model-female">
                        <div class="model-icon">ğŸ‘©</div>
                        <div class="model-name">å¥³æ€§æ¨¡ç‰¹å…’</div>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">B02</div>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">ğŸ–ï¸ æ²»ç™‚æ‰‹æ³•</div>
                <div class="technique-list">
                    <button class="technique-btn" onclick="selectTechnique(1)">
                        <span class="technique-icon">ğŸ–ï¸</span>
                        <div class="technique-info">
                            <div class="technique-name">æ¨æ’«æ³• Effleurage</div>
                            <div class="technique-desc">æµæš¢æ¨å‹•ãƒ»èˆ’ç·©æ”¾é¬†</div>
                        </div>
                    </button>
                    
                    <button class="technique-btn" onclick="selectTechnique(2)">
                        <span class="technique-icon">ğŸ‘</span>
                        <div class="technique-info">
                            <div class="technique-name">æ‰ææ³• Petrissage</div>
                            <div class="technique-desc">æ·±å±¤æŒ‰æ‘©ãƒ»ä¿ƒé€²å¾ªç’°</div>
                        </div>
                    </button>
                    
                    <button class="technique-btn" onclick="selectTechnique(3)">
                        <span class="technique-icon">ğŸ‘†</span>
                        <div class="technique-info">
                            <div class="technique-name">æ‘©æ“¦æ³• Friction</div>
                            <div class="technique-desc">åœ“å½¢æ‘©æ“¦ãƒ»é¬†è§£ç·Šç¹ƒ</div>
                        </div>
                    </button>
                    
                    <button class="technique-btn" onclick="selectTechnique(4)">
                        <span class="technique-icon">âœŠ</span>
                        <div class="technique-info">
                            <div class="technique-name">å©æ“Šæ³• Tapotement</div>
                            <div class="technique-desc">ç¯€å¥æ‹æ‰“ãƒ»åˆºæ¿€ç¥ç¶“</div>
                        </div>
                    </button>
                    
                    <button class="technique-btn" onclick="selectTechnique(5)">
                        <span class="technique-icon">ğŸŒŠ</span>
                        <div class="technique-info">
                            <div class="technique-name">éœ‡é¡«æ³• Vibration</div>
                            <div class="technique-desc">å¿«é€Ÿé¡«å‹•ãƒ»æ·±åº¦æ”¾é¬†</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <div class="patient-info">
                <h3>ğŸ“‹ æ¨¡ç‰¹å…’è³‡è¨Š</h3>
                <div class="info-row">
                    <span>å§“åï¼š</span>
                    <span id="patient-name">æœªé¸æ“‡</span>
                </div>
                <div class="info-row">
                    <span>æ€§åˆ¥ï¼š</span>
                    <span id="patient-gender">-</span>
                </div>
                <div class="info-row">
                    <span>æ¨¡å‹ï¼š</span>
                    <span id="patient-model">-</span>
                </div>
                <div class="info-row">
                    <span>ç‹€æ…‹ï¼š</span>
                    <span id="patient-status">å¾…æ²»ç™‚</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">ğŸ“Š æ²»ç™‚é€²åº¦</div>
                <div class="progress-section">
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>æ”¾é¬†åº¦</span>
                            <span id="relax-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="relax-bar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                    
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>å¾ªç’°æ”¹å–„</span>
                            <span id="circulation-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="circulation-bar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                    
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>è‚Œè‚‰èˆ’ç·©</span>
                            <span id="muscle-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="muscle-bar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                    
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>æ•´é«”ç™‚æ•ˆ</span>
                            <span id="overall-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="overall-bar" style="width: 0%; background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">ğŸ“ˆ æœ¬æ¬¡æ²»ç™‚</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                    <div>
                        <div style="opacity: 0.7;">æ²»ç™‚æ¬¡æ•¸</div>
                        <div style="font-size: 20px; font-weight: bold; color: #667eea;" id="treatment-count">0</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">æ²»ç™‚æ™‚é–“</div>
                        <div style="font-size: 20px; font-weight: bold; color: #667eea;" id="treatment-time">0:00</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="tool-btn" onclick="resetCamera()">
                <span>ğŸ”„</span>
                <span>é‡ç½®è¦–è§’</span>
            </button>
            <button class="tool-btn vr-btn" onclick="toggleVR()" id="vr-toggle">
                <span>ğŸ¥½</span>
                <span>é€²å…¥VR</span>
            </button>
            <button class="tool-btn" onclick="resetTreatment()">
                <span>ğŸ”„</span>
                <span>é‡ç½®æ²»ç™‚</span>
            </button>
        </div>

        <div class="interaction-hint" id="interaction-hint">
            ğŸ‘† é»æ“Šæ¨¡ç‰¹å…’èº«é«”éƒ¨ä½é€²è¡Œæ²»ç™‚
        </div>

        <div class="treatment-effect" id="treatment-effect"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/VRButton.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let scene, camera, renderer, controls, spaceModel, patientModel;
        let raycaster, mouse;
        let isVRMode = false;
        let currentPatient = null;
        let selectedTechnique = null;
        let treatmentProgress = {
            relax: 0,
            circulation: 0,
            muscle: 0,
            overall: 0
        };
        let treatmentCount = 0;
        let treatmentStartTime = null;
        let timerInterval = null;

        const techniqueNames = {
            1: 'æ¨æ’«æ³•',
            2: 'æ‰ææ³•',
            3: 'æ‘©æ“¦æ³•',
            4: 'å©æ“Šæ³•',
            5: 'éœ‡é¡«æ³•'
        };

        const techniqueEffects = {
            1: { relax: 15, circulation: 10, muscle: 10 },
            2: { relax: 10, circulation: 20, muscle: 15 },
            3: { relax: 10, circulation: 15, muscle: 20 },
            4: { relax: 5, circulation: 15, muscle: 10 },
            5: { relax: 20, circulation: 10, muscle: 15 }
        };

        // é€²å…¥ç©ºé–“
        function enterSpace(vr) {
            isVRMode = vr;
            document.getElementById('welcome-screen').classList.add('hidden');
            initScene();
            loadSpace();
        }

        // åˆå§‹åŒ–3Då ´æ™¯
        function initScene() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            
            // ç›¸æ©Ÿè¨­å®š - èª¿æ•´ç‚ºæ›´å¥½çš„åˆå§‹è¦–è§’
            camera = new THREE.PerspectiveCamera(
                75,  // è¦–é‡è§’åº¦
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            
            // åˆå§‹ç›¸æ©Ÿä½ç½® - å¾åºŠçš„æ–œä¸Šæ–¹ä¿¯è¦–
            // èª¿æ•´ Z å€¼è®“ç›¸æ©Ÿå°æº–åºŠçš„ä½ç½®ï¼ˆåºŠåœ¨ Z = -2.0 é™„è¿‘ï¼‰
            camera.position.set(3, 3, 2);  // (X, Y, Z)
            camera.lookAt(0, 1, -2);       // çœ‹å‘åºŠçš„ä½ç½®
            
            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.xr.enabled = isVRMode;
            container.appendChild(renderer.domElement);
            
            // è»Œé“æ§åˆ¶å™¨ - å…è¨±è‡ªç”±ç§»å‹•è¦–è§’
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 20;
            controls.maxPolarAngle = Math.PI / 1.5;
            controls.target.set(0, 1, 0);
            
            // VRæŒ‰éˆ•
            if (isVRMode && navigator.xr) {
                document.body.appendChild(THREE.VRButton.createButton(renderer));
            }
            
            // å…‰æºè¨­å®š
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(0, 15, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            const spotLight1 = new THREE.SpotLight(0xffffff, 0.6);
            spotLight1.position.set(-8, 12, 0);
            scene.add(spotLight1);
            
            const spotLight2 = new THREE.SpotLight(0xffffff, 0.6);
            spotLight2.position.set(8, 12, 0);
            scene.add(spotLight2);
            
            // å°„ç·šæª¢æ¸¬ï¼ˆç”¨æ–¼é»æ“Šäº’å‹•ï¼‰
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // é»æ“Šäº‹ä»¶
            renderer.domElement.addEventListener('click', onModelClick);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            
            // å‹•ç•«å¾ªç’°
            renderer.setAnimationLoop(animate);
        }

        // è¼‰å…¥ç©ºé–“
        function loadSpace() {
            showLoading('è¼‰å…¥é†«ç™‚ç©ºé–“ A01...');
            
            const loader = new THREE.GLTFLoader();
            loader.load(
                'A01.glb',
                function(gltf) {
                    spaceModel = gltf.scene;
                    
                    // æ”¾å¤§æˆ¿é–“å ´æ™¯
                    const box = new THREE.Box3().setFromObject(spaceModel);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 20 / maxDim; // æ”¾å¤§æˆ¿é–“
                    spaceModel.scale.set(scale, scale, scale);
                    
                    const center = box.getCenter(new THREE.Vector3());
                    spaceModel.position.set(-center.x * scale, -center.y * scale, -center.z * scale);
                    
                    spaceModel.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    scene.add(spaceModel);
                    hideLoading();
                    
                    console.log('æˆ¿é–“å·²è¼‰å…¥ï¼Œå°ºå¯¸:', size, 'ç¸®æ”¾:', scale);
                },
                function(xhr) {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                    document.getElementById('loading-text').textContent = `è¼‰å…¥ç©ºé–“... ${percent}%`;
                },
                function(error) {
                    console.error('è¼‰å…¥å¤±æ•—:', error);
                    hideLoading();
                }
            );
        }

        // é¸æ“‡æ¨¡ç‰¹å…’
        function selectModel(gender) {
            showLoading(`è¼‰å…¥${gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}æ¨¡ç‰¹å…’...`);
            
            if (patientModel) {
                scene.remove(patientModel);
            }
            
            document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
            document.getElementById('model-' + gender).classList.add('active');
            
            const modelFile = gender === 'male' ? 'B01.glb' : 'B02.glb';
            const modelName = gender === 'male' ? 'B01' : 'B02';
            const patientName = gender === 'male' ? 'ç”·æ€§æ¨¡ç‰¹å…’' : 'å¥³æ€§æ¨¡ç‰¹å…’';
            
            const loader = new THREE.GLTFLoader();
            loader.load(
                modelFile,
                function(gltf) {
                    patientModel = gltf.scene;
                    
                    // èª¿æ•´æ¨¡ç‰¹å…’å¤§å°
                    const modelScale = 3.5; // ç¨å¾®ç¸®å°ï¼Œæ›´ç¬¦åˆåºŠçš„æ¯”ä¾‹
                    patientModel.scale.set(modelScale, modelScale, modelScale);
                    
                    // ===== æ–¹å‘è¨­å®š =====
                    // è®“æ¨¡ç‰¹å…’å¹³èººï¼Œé ­æœä¸Šï¼ˆZè»¸æ­£æ–¹å‘ï¼‰ï¼Œè…³æœä¸‹ï¼ˆZè»¸è² æ–¹å‘ï¼‰
                    patientModel.rotation.x = -Math.PI / 2;  // èººä¸‹ï¼ˆé¢æœä¸Šï¼‰
                    patientModel.rotation.z = Math.PI;       // æ—‹è½‰180åº¦ä½¿é ­è…³æ–¹å‘æ­£ç¢º
                    
                    // ===== ä½ç½®è¨­å®š =====
                    // æ ¹æ“šæ‚¨çš„æˆªåœ–ï¼ŒåºŠå¤§ç´„åœ¨ Z = -1.5 åˆ° -2.5 ä¹‹é–“
                    // åºŠçš„é«˜åº¦å¤§ç´„åœ¨ Y = 0.8 åˆ° 1.2 ä¹‹é–“
                    patientModel.position.set(
                        0,      // Xè»¸ï¼šåºŠçš„ä¸­å¤®ï¼ˆå·¦å³å±…ä¸­ï¼‰
                        0.9,    // Yè»¸ï¼šåºŠé¢é«˜åº¦ï¼ˆé™ä½ä¸€é»é¿å…æµ®ç©ºï¼‰
                        -2.0    // Zè»¸ï¼šåºŠçš„å‰å¾Œä½ç½®ï¼ˆå¾€å¾Œç§»ï¼Œç¢ºä¿åœ¨åºŠä¸Šï¼‰
                    );
                    
                    console.log('=== æ¨¡ç‰¹å…’å·²è¼‰å…¥ ===');
                    console.log('ä½ç½®:', patientModel.position);
                    console.log('æ—‹è½‰:', patientModel.rotation);
                    console.log('å¦‚æœä½ç½®ä¸å°ï¼Œè«‹æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°');
                    console.log('å¯ä»¥å³æ™‚èª¿æ•´ï¼š');
                    console.log('  patientModel.position.y = 1.0  // èª¿æ•´é«˜åº¦');
                    console.log('  patientModel.position.z = -2.5 // èª¿æ•´å‰å¾Œ');
                    console.log('==================');
                    
                    patientModel.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // è¨­å®šç‚ºå¯äº’å‹•
                            child.userData.clickable = true;
                        }
                    });
                    
                    scene.add(patientModel);
                    
                    // æ›´æ–°è³‡è¨Š
                    currentPatient = gender;
                    document.getElementById('current-patient').textContent = patientName;
                    document.getElementById('patient-name').textContent = patientName;
                    document.getElementById('patient-gender').textContent = gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
                    document.getElementById('patient-model').textContent = modelName;
                    document.getElementById('patient-status').textContent = 'æº–å‚™æ²»ç™‚';
                    
                    if (!treatmentStartTime) {
                        treatmentStartTime = Date.now();
                        startTimer();
                    }
                    
                    hideLoading();
                    console.log('æ¨¡ç‰¹å…’å·²è¼‰å…¥ï¼Œä½ç½®:', patientModel.position);
                },
                function(xhr) {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                    document.getElementById('loading-text').textContent = `è¼‰å…¥æ¨¡ç‰¹å…’... ${percent}%`;
                },
                function(error) {
                    console.error('è¼‰å…¥å¤±æ•—:', error);
                    hideLoading();
                }
            );
        }

        // é¸æ“‡æ²»ç™‚æ‰‹æ³•
        function selectTechnique(id) {
            selectedTechnique = id;
            document.getElementById('current-technique').textContent = techniqueNames[id];
            
            document.querySelectorAll('.technique-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            showTreatmentEffect(`âœ… ${techniqueNames[id]} å·²é¸æ“‡`);
        }

        // é»æ“Šæ¨¡ç‰¹å…’é€²è¡Œæ²»ç™‚
        function onModelClick(event) {
            if (!currentPatient || !selectedTechnique) {
                if (!currentPatient) {
                    alert('è«‹å…ˆé¸æ“‡æ¨¡ç‰¹å…’ï¼');
                } else {
                    alert('è«‹å…ˆé¸æ“‡æ²»ç™‚æ‰‹æ³•ï¼');
                }
                return;
            }
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            if (patientModel) {
                const intersects = raycaster.intersectObject(patientModel, true);
                
                if (intersects.length > 0) {
                    applyTreatment();
                }
            }
        }

        // æ»‘é¼ ç§»å‹•ï¼ˆé¡¯ç¤ºå¯é»æ“Šå€åŸŸï¼‰
        function onMouseMove(event) {
            if (!patientModel) return;
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(patientModel, true);
            
            const crosshair = document.getElementById('crosshair');
            if (intersects.length > 0 && selectedTechnique) {
                crosshair.classList.add('active');
                renderer.domElement.style.cursor = 'pointer';
            } else {
                crosshair.classList.remove('active');
                renderer.domElement.style.cursor = 'default';
            }
        }

        // æ‡‰ç”¨æ²»ç™‚
        function applyTreatment() {
            const effects = techniqueEffects[selectedTechnique];
            treatmentProgress.relax = Math.min(100, treatmentProgress.relax + effects.relax);
            treatmentProgress.circulation = Math.min(100, treatmentProgress.circulation + effects.circulation);
            treatmentProgress.muscle = Math.min(100, treatmentProgress.muscle + effects.muscle);
            treatmentProgress.overall = Math.round((treatmentProgress.relax + treatmentProgress.circulation + treatmentProgress.muscle) / 3);
            
            updateProgress();
            
            treatmentCount++;
            document.getElementById('treatment-count').textContent = treatmentCount;
            
            showTreatmentEffect(`âœ¨ ${techniqueNames[selectedTechnique]} æ²»ç™‚å®Œæˆï¼+${effects.relax + effects.circulation + effects.muscle}%`);
            
            if (treatmentProgress.overall >= 100) {
                document.getElementById('patient-status').textContent = 'âœ… æ²»ç™‚å®Œæˆ';
                showTreatmentEffect('ğŸ‰ æ­å–œï¼é”æˆ100%ç™‚æ•ˆï¼');
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress() {
            const updateBar = (id, value) => {
                document.getElementById(id + '-bar').style.width = value + '%';
                document.getElementById(id + '-bar').textContent = value + '%';
                document.getElementById(id + '-value').textContent = value + '%';
            };
            
            updateBar('relax', treatmentProgress.relax);
            updateBar('circulation', treatmentProgress.circulation);
            updateBar('muscle', treatmentProgress.muscle);
            updateBar('overall', treatmentProgress.overall);
        }

        // VRåˆ‡æ›
        function toggleVR() {
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                    if (supported) {
                        renderer.xr.enabled = true;
                        const sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking'] };
                        navigator.xr.requestSession('immersive-vr', sessionInit).then(onSessionStarted);
                    } else {
                        alert('æ‚¨çš„è£ç½®ä¸æ”¯æ´WebXR VR');
                    }
                });
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´WebXR');
            }
        }

        function onSessionStarted(session) {
            session.addEventListener('end', onSessionEnded);
            renderer.xr.setSession(session);
            document.getElementById('vr-toggle').innerHTML = '<span>ğŸ¥½</span><span>é€€å‡ºVR</span>';
        }

        function onSessionEnded() {
            document.getElementById('vr-toggle').innerHTML = '<span>ğŸ¥½</span><span>é€²å…¥VR</span>';
        }

        // é‡ç½®æ²»ç™‚
        function resetTreatment() {
            if (!confirm('ç¢ºå®šè¦é‡ç½®æ²»ç™‚é€²åº¦å—ï¼Ÿ')) return;
            
            treatmentProgress = { relax: 0, circulation: 0, muscle: 0, overall: 0 };
            treatmentCount = 0;
            treatmentStartTime = Date.now();
            
            updateProgress();
            document.getElementById('treatment-count').textContent = '0';
            document.getElementById('patient-status').textContent = 'æº–å‚™æ²»ç™‚';
            
            showTreatmentEffect('ğŸ”„ æ²»ç™‚é€²åº¦å·²é‡ç½®');
        }

        // é‡ç½®ç›¸æ©Ÿ
        function resetCamera() {
            camera.position.set(3, 3, 2);  // å¾æ–œä¸Šæ–¹çœ‹åºŠ
            controls.target.set(0, 1, -2); // çœ‹å‘åºŠçš„ä½ç½®
            controls.update();
        }

        // è¨ˆæ™‚å™¨
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - treatmentStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('treatment-time').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // é¡¯ç¤ºæ²»ç™‚æ•ˆæœ
        function showTreatmentEffect(message) {
            const effect = document.getElementById('treatment-effect');
            effect.textContent = message;
            effect.classList.add('show');
            
            setTimeout(() => {
                effect.classList.remove('show');
            }, 2000);
        }

        // è¼‰å…¥/éš±è—è¼‰å…¥ç•«é¢
        function showLoading(text = 'è¼‰å…¥ä¸­...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // å‹•ç•«å¾ªç’°
        function animate() {
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        // è¦–çª—èª¿æ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
