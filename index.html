<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è‰¾æŸåœ‹éš›èŠ³ç™‚ - æ²‰æµ¸å¼ç‘å…¸æŒ‰æ‘© VR æ•™å­¸ (V4.4 æ—‹è½‰è§£é–ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: #1a1a1a;
            overflow: hidden;
            touch-action: none;
        }
        
        /* --- UI å±¤ --- */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 15px 25px; color: white; display: flex; justify-content: space-between;
            align-items: center; pointer-events: auto;
        }

        /* å·¦å´é¸å–® */
        .side-menu {
            position: absolute; left: 20px; top: 80px; width: 300px;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto; max-height: calc(100vh - 120px); overflow-y: auto;
            transform: translateX(-340px); transition: transform 0.3s ease; 
            z-index: 20;
        }
        .side-menu.show { transform: translateX(0); }
        
        .menu-title { 
            color: #8ec5fc; font-size: 14px; margin-bottom: 10px; font-weight: bold; 
            letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; 
            cursor: pointer;
        }
        
        .phase-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: #ccc; text-align: left; cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .phase-btn:hover { background: rgba(255,255,255,0.1); }
        .phase-btn.active { 
            background: linear-gradient(90deg, #667eea, #764ba2); 
            color: white; border: none; box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
        }

        /* å¾®èª¿æ»‘æ¡¿ (é è¨­éš±è—) */
        .debug-section { display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .adjust-row { margin-bottom: 12px; }
        .adjust-label { font-size: 12px; color: #ff6b6b; display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; }
        .adjust-input { width: 100%; cursor: pointer; accent-color: #ff6b6b; }

        /* åº•éƒ¨æ“ä½œå¡ç‰‡ */
        .action-card {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px);
            padding: 20px 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center; width: 90%; max-width: 500px;
            pointer-events: auto;
        }
        
        .instruction-title { color: #8ec5fc; font-size: 12px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .instruction-text { color: #fff; font-size: 20px; font-weight: bold; margin-bottom: 8px; }
        .instruction-note { color: #aaa; font-size: 14px; margin-bottom: 15px; line-height: 1.5; }

        .nav-btn {
            background: #444; color: white; border: none; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; margin: 0 5px; font-weight: bold;
            font-size: 14px; display: inline-flex; align-items: center; gap: 5px;
        }
        .nav-btn:hover { background: #555; }
        .nav-btn.primary { background: #667eea; }
        
        .lock-btn { background: #444; border: 1px solid #666; }
        .lock-btn.locked {
            background: #ff6b6b; border: 1px solid #ff4444;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        /* æµ®å‹•æ‰‹å‹¢æç¤º */
        .gesture-hint {
            position: absolute;
            background: rgba(102, 126, 234, 0.9); color: white;
            padding: 8px 16px; border-radius: 20px; font-weight: bold;
            font-size: 14px; pointer-events: none;
            opacity: 0; transition: opacity 0.3s;
            transform: translate(-50%, -100%);
            white-space: nowrap; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* æ­¡è¿/è¼‰å…¥é  */
        .welcome-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 20, 20, 0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }
        .main-title {
            font-size: 40px; font-weight: bold; color: #8ec5fc; 
            margin-bottom: 10px; letter-spacing: 2px;
        }
        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; padding: 15px 50px;
            font-size: 20px; border-radius: 50px; margin-top: 30px;
            cursor: pointer; box-shadow: 0 0 20px rgba(118, 75, 162, 0.6);
        }
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1); border-left-color: #667eea;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-top: 20px; display: none;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="welcome-overlay" id="welcome">
        <div class="main-title">è‰¾æŸåœ‹éš›èŠ³ç™‚</div>
        <h1 style="font-size: 32px; margin-bottom: 10px;">ğŸ¤² å°ˆæ¥­èŠ³ç™‚ VR æ•™å­¸</h1>
        <p style="color: #aaa;">æ²‰æµ¸å¼äº’å‹•ç‰ˆ v4.4 (æ—‹è½‰è§£é–)</p>
        <button class="start-btn" onclick="initApp()">é–‹å§‹ç™‚ç¨‹</button>
        <div class="loading-spinner" id="spinner"></div>
    </div>

    <div id="canvas-container" style="width:100vw; height:100vh;"></div>

    <div class="ui-layer" id="ui" style="display:none;">
        <div class="top-bar">
            <div style="font-weight: bold; font-size: 18px; display:flex; align-items:center; gap:10px;">
                <span style="font-size:24px;" id="current-tool-icon">ğŸ¤š</span>
                <span id="phase-title">éšæ®µä¸€ï¼šæº–å‚™èˆ‡èµ·å§‹</span>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="nav-btn lock-btn" id="lock-btn" onclick="toggleCameraLock()">ğŸ”“ é–å®šè¦–è§’</button>
                <button class="nav-btn" onclick="toggleMenu()">â˜° é¸å–®</button>
            </div>
        </div>

        <div class="side-menu" id="side-menu">
            <!-- éš±è—çš„å·¥ç¨‹æ¨¡å¼å€åŸŸ -->
            <div class="debug-section" id="debug-panel">
                <div class="menu-title" style="color:#ff6b6b; border-color:#ff6b6b;">ğŸ”§ å·¥ç¨‹æ¨¡å¼ (ä½ç½®/æ—‹è½‰)</div>
                <div class="adjust-row">
                    <div class="adjust-label"><span>å‰å¾Œ (X)</span> <span id="val-x">0.1</span></div>
                    <input type="range" class="adjust-input" id="range-x" min="-3" max="3" step="0.05" value="0.1" oninput="updateModelPos()">
                </div>
                <div class="adjust-row">
                    <div class="adjust-label"><span>é«˜åº¦ (Y)</span> <span id="val-y">2.3</span></div>
                    <input type="range" class="adjust-input" id="range-y" min="0" max="4" step="0.05" value="2.3" oninput="updateModelPos()">
                </div>
                <div class="adjust-row">
                    <div class="adjust-label"><span>å·¦å³ (Z)</span> <span id="val-z">0</span></div>
                    <input type="range" class="adjust-input" id="range-z" min="-2" max="2" step="0.05" value="0" oninput="updateModelPos()">
                </div>
                <div class="adjust-row">
                    <div class="adjust-label"><span>å¤§å° (Scale)</span> <span id="val-scale">1.0</span></div>
                    <input type="range" class="adjust-input" id="range-scale" min="0.5" max="50" step="0.1" value="1.0" oninput="updateModelPos()">
                </div>
                
                <div style="border-top:1px solid #555; margin:10px 0;"></div>
                <div class="adjust-label" style="color:#aaa; margin-bottom:5px;">æ—‹è½‰è¨­å®š (Rotation)</div>

                <div class="adjust-row">
                    <div class="adjust-label"><span>æ—‹è½‰ X</span> <span id="val-rot-x">-1.57</span></div>
                    <input type="range" class="adjust-input" id="range-rot-x" min="-6.28" max="6.28" step="0.1" value="-1.57" oninput="updateModelPos()">
                </div>
                <div class="adjust-row">
                    <div class="adjust-label"><span>æ—‹è½‰ Y</span> <span id="val-rot-y">0</span></div>
                    <input type="range" class="adjust-input" id="range-rot-y" min="-6.28" max="6.28" step="0.1" value="0" oninput="updateModelPos()">
                </div>
                <div class="adjust-row">
                    <div class="adjust-label"><span>æ—‹è½‰ Z</span> <span id="val-rot-z">1.57</span></div>
                    <input type="range" class="adjust-input" id="range-rot-z" min="-6.28" max="6.28" step="0.1" value="1.57" oninput="updateModelPos()">
                </div>
            </div>

            <!-- å¯è¦‹çš„é¸å–®å€åŸŸ -->
            <div class="menu-title" onclick="triggerDebugMode()">ç™‚ç¨‹éšæ®µé¸å–®</div>
            <button class="phase-btn active" onclick="setPhase(1)" id="p1">1. æº–å‚™èˆ‡èµ·å§‹å®‰æ’«</button>
            <button class="phase-btn" onclick="setPhase(2)" id="p2">2. å·¦è…¿æŒ‰æ‘©æ“ä½œ</button>
            <button class="phase-btn" onclick="setPhase(3)" id="p3">3. å³è…¿æŒ‰æ‘©æ“ä½œ</button>
            <button class="phase-btn" onclick="setPhase(4)" id="p4">4. çµå°¾èˆ‡å®‰æ’«</button>
            
            <div class="menu-title" style="margin-top:20px;">ä¸€èˆ¬è¨­å®š</div>
            <button class="phase-btn" onclick="resetCam()">ğŸ”„ é‡ç½®è¦–è§’</button>
            <button class="phase-btn" onclick="toggleModel()">ğŸ‘¤ åˆ‡æ›æ¨¡ç‰¹å…’</button>
        </div>

        <div class="gesture-hint" id="gesture-hint">ğŸ‘† æŒ‰ä½ä¸¦æ‹–æ›³</div>

        <div class="action-card">
            <div class="instruction-title">STEP <span id="step-num">1.1</span></div>
            <div class="instruction-text" id="action-text">è¼‰å…¥ä¸­...</div>
            <div class="instruction-note" id="action-note">è·Ÿéš¨æ‰‹éƒ¨æŒ‡å¼•æ“ä½œ</div>
            
            <div style="display:flex; justify-content: center; gap:10px;">
                <button class="nav-btn" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="nav-btn primary" onclick="forceComplete()">å®Œæˆæ­¥é©Ÿ</button>
                <button class="nav-btn" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "https://gp01002.github.io/TMS/";

        // --- è¨­å®šå€ (CONFIG) - V4.4 åŸå§‹è¨­å®š ---
        const CONFIG = {
            MODEL_POS_DEFAULT: { x: 0.1, y: 2.3, z: 0 },
            MODEL_SCALE: 1.0,
            // æ–°å¢æ—‹è½‰é è¨­å€¼ (å°æ‡‰ V4.4 çš„ç¡¬ç·¨ç¢¼å€¼)
            MODEL_ROT_DEFAULT: { x: -1.57, y: 0, z: 1.57 }, 

            LEFT_LEG_Z: 0.12,  
            RIGHT_LEG_Z: -0.12,
            
            // V4.4 ç‰ˆæœ¬çš„åº§æ¨™
            COORDS: {
                THIGH_ROOT: -3.3,    
                THIGH_MID: -2.4,     
                KNEE: -1.5,          
                CALF_MID: -0.7,      
                ANKLE: -0.2,         
                FOOT: 0.0            
            }
        };

        // --- å®Œæ•´ç™‚ç¨‹è³‡æ–™åº« (V4.4) ---
        const learningData = {
            1: [
                { id: "1.1", text: "åœ¨æ¯›å·¾ä¸Šä¿¯é †è‡³å¤§è…¿", note: "è¨­å®šå®¢æˆ¶ä½ç½®ï¼Œè¼•æŸ”åœ°å¾è†è“‹è™•å‘ä¸Šä¿¯é †è‡³å¤§è…¿ã€‚", type: "drag", tool: "towel", icon: "ğŸ§–â€â™€ï¸", start: {x: CONFIG.COORDS.KNEE, y: -0.2, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.LEFT_LEG_Z} },
                { id: "1.2", text: "ç”±å…©å´æ»‘ä¸‹è‡³è…³åº•", note: "é›™æ‰‹æ²¿è‘—è…¿éƒ¨å…©å´ï¼Œå‘ä¸‹æ»‘è‡³è…³åº•ã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.THIGH_MID, y: -0.25, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.FOOT, y: -0.35, z: CONFIG.LEFT_LEG_Z} },
                { id: "1.3", text: "å°‡æ¯›å·¾æ²åœ¨é›™è…¿ä¹‹é–“", note: "ç¢ºä¿æ¯›å·¾è¦†è“‹éš±ç§éƒ¨ä½ä¸¦å®šä½ã€‚", type: "click", tool: "towel", icon: "ğŸ§–â€â™€ï¸", pos: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.25, z: 0} }, 
                { id: "1.4", text: "é›™è…¿ç”±é˜¿åŸºé‡Œæ–¯è…±ä¸Šæ¨", note: "é›™è…¿åŒæ­¥æ“ä½œï¼Œå¾è…³è·Ÿå¾€ä¸Šæ¨ã€‚", type: "drag", tool: "hand", icon: "ğŸ¤²", start: {x: CONFIG.COORDS.FOOT, y: -0.35, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.KNEE, y: -0.25, z: CONFIG.LEFT_LEG_Z} },
                { id: "1.5", text: "å°‡å³è…³è¦†è“‹", note: "ç¢ºèªæ“ä½œç›®æ¨™ç‚ºå·¦è…³ï¼Œå…ˆå°‡å³è…³ä¿æš–ã€‚", type: "click", tool: "towel", icon: "ğŸ§–â€â™€ï¸", pos: {x: CONFIG.COORDS.KNEE, y: -0.2, z: CONFIG.RIGHT_LEG_Z} },
                { id: "1.6", text: "ä¸Šæ²¹", note: "å–é©é‡æŒ‰æ‘©æ²¹æ–½åŠ æ–¼é›™æ‰‹ã€‚", type: "press", tool: "oil", icon: "ğŸ§´", pos: {x: CONFIG.COORDS.KNEE, y: 0.2, z: 0}, duration: 2 }, 
                { id: "1.7", text: "å¤§å®‰æ’«", note: "å…©æ‰‹æ”¾åœ¨è…³åº•ï¼Œåœç•™åšåˆå§‹å»£æ³›å®‰æ’«ã€‚", type: "press", tool: "hand", icon: "âœ¨", pos: {x: CONFIG.COORDS.FOOT, y: -0.3, z: CONFIG.LEFT_LEG_Z}, duration: 3 }
            ],
            2: [
                { id: "2.1", text: "é›™æ‰‹æ‹‡æŒ‡ä¸¦æ’é•·æ¨", note: "å¾è…³è¸é•·æ¨è‡³å¤§è…¿ã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.ANKLE, y: -0.35, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.2", text: "ç”±å…©å´å›åŒ…", note: "å›ç¨‹å‹•ä½œï¼Œæ»‘å›è…³è¸ã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.ANKLE, y: -0.35, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.3", text: "æ’¥ææŠ€å·§", note: "ç”±ä¸‹è‡³ä¸Šï¼Œåˆ†æ®µå‘å…©å´æã€‚", type: "drag", tool: "hand", icon: "ğŸ¤", start: {x: CONFIG.COORDS.CALF_MID, y: -0.25, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.CALF_MID, y: -0.2, z: CONFIG.LEFT_LEG_Z + 0.1} },
                { id: "2.4", text: "å¤§è…¿å…§å¤–å´æ“ä½œ", note: "å¤§è…¿åˆ†ç‚ºå…§å¤–å´ï¼Œç”±å…§è‡³å¤–æ“ä½œã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.THIGH_MID, y: -0.2, z: CONFIG.LEFT_LEG_Z - 0.1}, end: {x: CONFIG.COORDS.THIGH_MID, y: -0.2, z: CONFIG.LEFT_LEG_Z + 0.1} },
                { id: "2.5", text: "é›™æ‰‹äº¤æ›¿å‘ä¸Šæ’«é †", note: "ä½¿ç”¨äº¤æ›¿æ‰‹é€²è¡Œæ’«é †é•·æ¨ã€‚", type: "drag", tool: "hand", icon: "ğŸ‘‹", start: {x: CONFIG.COORDS.KNEE, y: -0.2, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.6", text: "å°è…¿é•·æ¨è‡³å§”ä¸­ç©´", note: "é•·æ¨åˆ°è†è“‹å¾Œæ–¹ç©´ä½ã€‚", type: "drag", tool: "hand", icon: "ğŸ¦µ", start: {x: CONFIG.COORDS.ANKLE, y: -0.3, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.KNEE, y: -0.25, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.7", text: "å°è…¿åˆ†ä¸‰ç­‰ä»½æ“ä½œ", note: "ç”±å…§è‡³å¤–ï¼šå…§ã€ä¸­ã€å¤–ï¼Œå…±ä¸‰æ¬¡ã€‚", type: "drag", tool: "hand", icon: "ğŸ“Š", start: {x: CONFIG.COORDS.CALF_MID, y: -0.3, z: CONFIG.LEFT_LEG_Z - 0.05}, end: {x: CONFIG.COORDS.KNEE, y: -0.25, z: CONFIG.LEFT_LEG_Z - 0.05} },
                { id: "2.8", text: "å°‡è…³æŠ¬èµ· 90 åº¦", note: "ä¸€æ‰‹æ‰˜è…³ç›¤ï¼Œæº–å‚™è…³åº•å‹•ä½œã€‚", type: "click", tool: "hand", icon: "ğŸ¦¶", pos: {x: CONFIG.COORDS.FOOT, y: -0.3, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.9", text: "æ¹§æ³‰ç©´ç•«åœˆ", note: "ç”±æ¹§æ³‰ç©´å‡ºç™¼ï¼Œé †æ™‚é˜ç•«åœˆã€‚", type: "press", tool: "hand", icon: "â­•", pos: {x: CONFIG.COORDS.FOOT + 0.05, y: -0.2, z: CONFIG.LEFT_LEG_Z}, duration: 3 },
                { id: "2.10", text: "éæ‹³æ»‘å‹•", note: "ä½¿ç”¨æ‹³é ­ç”±è…³è·Ÿå¾€è…³è¶¾æ»‘å‹•ã€‚", type: "drag", tool: "hand", icon: "ğŸ¤›", start: {x: CONFIG.COORDS.ANKLE, y: -0.2, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.FOOT + 0.1, y: -0.15, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.11", text: "è…³æŒå¿ƒæŒå£“", note: "è‚©è†€æ”¾é¬†ï¼Œä¿æŒå§¿å‹¢ã€‚", type: "press", tool: "hand", icon: "âœ‹", pos: {x: CONFIG.COORDS.FOOT + 0.05, y: -0.2, z: CONFIG.LEFT_LEG_Z}, duration: 2 },
                { id: "2.12", text: "å–®é‚ŠçµæŸå®‰æ’«", note: "çµæŸå·¦è…³å‹•ä½œã€‚", type: "drag", tool: "hand", icon: "âœ¨", start: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.LEFT_LEG_Z}, end: {x: CONFIG.COORDS.FOOT, y: -0.35, z: CONFIG.LEFT_LEG_Z} },
                { id: "2.13", text: "è“‹ä¸Šæ¯›å·¾", note: "è¦†è“‹å·¦è…³ã€‚", type: "click", tool: "towel", icon: "ğŸ§–â€â™€ï¸", pos: {x: CONFIG.COORDS.KNEE, y: -0.1, z: CONFIG.LEFT_LEG_Z} }
            ],
            3: [
                { id: "3.1", text: "å³è…¿ï¼šæ‹‡æŒ‡ä¸¦æ’é•·æ¨", note: "é•·æ¨å¾ä¸‹å¾€ä¸Šåˆ°å¤§è…¿ã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.ANKLE, y: -0.35, z: CONFIG.RIGHT_LEG_Z}, end: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.RIGHT_LEG_Z} },
                { id: "3.2", text: "ç”±å…©å´å›åŒ…", note: "å›ç¨‹å‹•ä½œã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.RIGHT_LEG_Z}, end: {x: CONFIG.COORDS.ANKLE, y: -0.35, z: CONFIG.RIGHT_LEG_Z} },
                { id: "3.3", text: "æ’¥ææŠ€å·§", note: "ç”±ä¸‹è‡³ä¸Šï¼Œåˆ†æ®µå…©å´æã€‚", type: "drag", tool: "hand", icon: "ğŸ¤", start: {x: CONFIG.COORDS.CALF_MID, y: -0.25, z: CONFIG.RIGHT_LEG_Z}, end: {x: CONFIG.COORDS.CALF_MID, y: -0.2, z: CONFIG.RIGHT_LEG_Z - 0.1} },
                { id: "3.4", text: "S å‹æŠ“æ", note: "åŸ·è¡Œ S å‹çš„ææ³•ï¼Œæ”¾é¬†è‚Œè‚‰ã€‚", type: "drag", tool: "hand", icon: "ã€°ï¸", start: {x: CONFIG.COORDS.THIGH_MID, y: -0.2, z: CONFIG.RIGHT_LEG_Z - 0.05}, end: {x: CONFIG.COORDS.THIGH_MID, y: -0.2, z: CONFIG.RIGHT_LEG_Z + 0.05} }, 
                { id: "3.5", text: "å¤§è…¿å…§å¤–å´æ“ä½œ", note: "ç”±å…§è‡ªå¤–æ“ä½œã€‚", type: "drag", tool: "hand", icon: "ğŸ‘", start: {x: CONFIG.COORDS.THIGH_MID, y: -0.2, z: CONFIG.RIGHT_LEG_Z + 0.1}, end: {x: CONFIG.COORDS.THIGH_MID, y: -0.2, z: CONFIG.RIGHT_LEG_Z - 0.1} },
                { id: "3.6", text: "äº¤æ›¿å‘ä¸Šæ’«é †", note: "äº¤æ›¿æ‰‹é•·æ¨ã€‚", type: "drag", tool: "hand", icon: "ğŸ‘‹", start: {x: CONFIG.COORDS.KNEE, y: -0.2, z: CONFIG.RIGHT_LEG_Z}, end: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: CONFIG.RIGHT_LEG_Z} },
                { id: "3.7", text: "å°è…¿é•·æ¨è‡³å§”ä¸­ç©´", note: "é•·æ¨åˆ°è†è“‹å¾Œæ–¹ã€‚", type: "drag", tool: "hand", icon: "ğŸ¦µ", start: {x: CONFIG.COORDS.ANKLE, y: -0.3, z: CONFIG.RIGHT_LEG_Z}, end: {x: CONFIG.COORDS.KNEE, y: -0.25, z: CONFIG.RIGHT_LEG_Z} },
                { id: "3.8", text: "å°è…¿åˆ†ä¸‰ç­‰ä»½", note: "ç”±å…§è‡³å¤–ï¼šå…§ã€ä¸­ã€å¤–ã€‚", type: "drag", tool: "hand", icon: "ğŸ“Š", start: {x: CONFIG.COORDS.CALF_MID, y: -0.3, z: CONFIG.RIGHT_LEG_Z + 0.05}, end: {x: CONFIG.COORDS.KNEE, y: -0.25, z: CONFIG.RIGHT_LEG_Z + 0.05} },
                { id: "3.9", text: "å°‡è…³æŠ¬èµ· 90 åº¦", note: "æº–å‚™è…³åº•å‹•ä½œã€‚", type: "click", tool: "hand", icon: "ğŸ¦¶", pos: {x: CONFIG.COORDS.FOOT, y: -0.3, z: CONFIG.RIGHT_LEG_Z} },
                { id: "3.10", text: "æ¹§æ³‰ç©´ç•«åœˆ", note: "é †æ™‚é˜ç•«åœˆï¼Œç¶“è¶³å¼“å›æ¹§æ³‰ã€‚", type: "press", tool: "hand", icon: "â­•", pos: {x: CONFIG.COORDS.FOOT + 0.05, y: -0.2, z: CONFIG.RIGHT_LEG_Z}, duration: 3 },
                { id: "3.11", text: "åŠæ¡æ‹³æ»‘å‹•", note: "ç”±è…³è·Ÿå¾€è…³è¶¾æ–¹å‘æ»‘å‹•ã€‚", type: "drag", tool: "hand", icon: "ğŸ¤›", start: {x: CONFIG.COORDS.ANKLE, y: -0.2, z: CONFIG.RIGHT_LEG_Z}, end: {x: CONFIG.COORDS.FOOT + 0.1, y: -0.15, z: CONFIG.RIGHT_LEG_Z} },
                { id: "3.12", text: "è…³æŒå¿ƒæŒå£“", note: "è‚©è†€æ”¾é¬†ï¼Œä¿æŒå§¿å‹¢ã€‚", type: "press", tool: "hand", icon: "âœ‹", pos: {x: CONFIG.COORDS.FOOT + 0.05, y: -0.2, z: CONFIG.RIGHT_LEG_Z}, duration: 2 },
                { id: "3.13", text: "éœç½®æ¡æŒ", note: "æŒçºŒæŒ‰å£“ 10 ç§’ã€‚", type: "press", tool: "hand", icon: "â±ï¸", pos: {x: CONFIG.COORDS.FOOT + 0.05, y: -0.2, z: CONFIG.RIGHT_LEG_Z}, duration: 10 }
            ],
            4: [
                { id: "4.1", text: "æ•´ç†æ¯›å·¾", note: "å°‡è“‹ä¸Šä¹‹å‰å°‡æ¯›å·¾æ²åˆ°ä¸­é–“ã€‚", type: "click", tool: "towel", icon: "ğŸ§–â€â™€ï¸", pos: {x: CONFIG.COORDS.KNEE, y: -0.2, z: 0} },
                { id: "4.2", text: "å¤§å®‰æ’«", note: "é€²è¡Œæœ€çµ‚çš„å»£æ³›å®‰æ’«ã€‚", type: "drag", tool: "hand", icon: "âœ¨", start: {x: CONFIG.COORDS.THIGH_ROOT, y: -0.2, z: 0}, end: {x: CONFIG.COORDS.FOOT, y: -0.35, z: 0} },
                { id: "4.3", text: "é›™æ‰‹åœç•™è…³åº•", note: "åœç•™ï¼Œèƒ½é‡å¹³è¡¡ã€‚", type: "press", tool: "hand", icon: "ğŸ§˜", pos: {x: CONFIG.COORDS.FOOT, y: -0.35, z: 0}, duration: 5 },
                { id: "4.4", text: "è“‹ä¸Šæ¯›å·¾", note: "å®Œæ•´è¦†è“‹çµæŸç™‚ç¨‹ã€‚", type: "click", tool: "towel", icon: "ğŸ§–â€â™€ï¸", pos: {x: CONFIG.COORDS.KNEE, y: -0.1, z: 0} }
            ]
        };

        let scene, camera, renderer, controls, model;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let interactables = []; 
        let currentPhase = 1;
        let currentStepIndex = 0;
        let isDragging = false;
        let isCameraLocked = false; 
        let ghostHand; 
        let tweenAnim;
        let activeModelType = 'male';
        
        // åˆå§‹ç‹€æ…‹
        let modelPos = { ...CONFIG.MODEL_POS_DEFAULT };
        let modelRot = { ...CONFIG.MODEL_ROT_DEFAULT };
        let modelScale = CONFIG.MODEL_SCALE;
        let debugClickCount = 0;

        function initApp() {
            document.getElementById('spinner').style.display = 'block';
            document.querySelector('.start-btn').style.display = 'none';
            setTimeout(initThreeJS, 100);
            
            // åˆå§‹åŒ–æ»‘æ¡¿
            document.getElementById('range-x').value = modelPos.x;
            document.getElementById('range-y').value = modelPos.y;
            document.getElementById('range-z').value = modelPos.z;
            document.getElementById('range-scale').value = modelScale;
            document.getElementById('range-rot-x').value = modelRot.x;
            document.getElementById('range-rot-y').value = modelRot.y;
            document.getElementById('range-rot-z').value = modelRot.z;
            updateDebugLabels();
        }
        
        function triggerDebugMode() {
            debugClickCount++;
            if(debugClickCount >= 5) {
                document.getElementById('debug-panel').style.display = 'block';
                alert("ğŸ”§ å·¥ç¨‹æ¨¡å¼å·²å•Ÿç”¨");
                debugClickCount = 0;
            }
        }

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            scene.fog = new THREE.Fog(0x1a1a1a, 5, 15);
            
            const ambient = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambient);
            
            const spotLight = new THREE.SpotLight(0xffeeb1, 1.2);
            spotLight.position.set(2, 6, 2);
            spotLight.angle = Math.PI / 5;
            spotLight.penumbra = 0.3;
            spotLight.castShadow = true;
            spotLight.shadow.mapSize.width = 1024;
            spotLight.shadow.mapSize.height = 1024;
            scene.add(spotLight);
            
            const fillLight = new THREE.DirectionalLight(0xaaccff, 0.3);
            fillLight.position.set(-2, 2, -2);
            scene.add(fillLight);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(1.5, 2.5, 2.5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxDistance = 6;
            
            const canvas = renderer.domElement;
            canvas.addEventListener('mousedown', onPointerDown);
            canvas.addEventListener('mousemove', onPointerMove);
            canvas.addEventListener('mouseup', onPointerUp);
            canvas.addEventListener('touchstart', onTouchStart, {passive: false});
            canvas.addEventListener('touchmove', onTouchMove, {passive: false});
            canvas.addEventListener('touchend', onPointerUp);
            window.addEventListener('resize', onWindowResize);

            renderer.setAnimationLoop(() => {
                controls.update();
                interactables.forEach(obj => { if(obj.tick) obj.tick(); });
                if (ghostHand) ghostHand.lookAt(camera.position);
                renderer.render(scene, camera);
            });

            loadEnvironment();
        }

        function loadEnvironment() {
            const loader = new THREE.GLTFLoader();
            loader.load(BASE_URL + 'A01.glb', (gltf) => {
                const room = gltf.scene;
                room.scale.set(20, 20, 20); // åºŠçš„æ¯”ä¾‹
                room.traverse(c => { if(c.isMesh) c.receiveShadow = true; });
                scene.add(room);
            });
            loadModel('male');
        }

        function loadModel(type) {
            if(model) scene.remove(model);
            activeModelType = type;
            const loader = new THREE.GLTFLoader();
            loader.load(BASE_URL + (type === 'male' ? 'B01.glb' : 'B02.glb'), (gltf) => {
                model = gltf.scene;
                model.position.set(modelPos.x, modelPos.y, modelPos.z);
                model.scale.set(modelScale, modelScale, modelScale);
                model.rotation.set(modelRot.x, modelRot.y, modelRot.z);
                
                model.traverse(c => { if(c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
                scene.add(model);
                
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                createGhostHand();
                setPhase(1);
            });
        }

        function updateModelPos() {
            const x = parseFloat(document.getElementById('range-x').value);
            const y = parseFloat(document.getElementById('range-y').value);
            const z = parseFloat(document.getElementById('range-z').value);
            const scale = parseFloat(document.getElementById('range-scale').value);
            const rx = parseFloat(document.getElementById('range-rot-x').value);
            const ry = parseFloat(document.getElementById('range-rot-y').value);
            const rz = parseFloat(document.getElementById('range-rot-z').value);
            
            modelPos = { x, y, z };
            modelScale = scale;
            modelRot = { x: rx, y: ry, z: rz };
            updateDebugLabels();

            if (model) {
                model.position.set(x, y, z);
                model.scale.set(scale, scale, scale);
                model.rotation.set(rx, ry, rz);
                setupStep();
            }
        }
        
        function updateDebugLabels() {
            document.getElementById('val-x').innerText = modelPos.x.toFixed(2);
            document.getElementById('val-y').innerText = modelPos.y.toFixed(2);
            document.getElementById('val-z').innerText = modelPos.z.toFixed(2);
            document.getElementById('val-scale').innerText = modelScale.toFixed(1);
            document.getElementById('val-rot-x').innerText = modelRot.x.toFixed(2);
            document.getElementById('val-rot-y').innerText = modelRot.y.toFixed(2);
            document.getElementById('val-rot-z').innerText = modelRot.z.toFixed(2);
        }

        function toggleCameraLock() {
            isCameraLocked = !isCameraLocked;
            controls.enabled = !isCameraLocked;
            
            const btn = document.getElementById('lock-btn');
            if (isCameraLocked) {
                btn.innerHTML = 'ğŸ”’ å·²é–å®š';
                btn.classList.add('locked');
                showHint(window.innerWidth/2, 100, "è¦–è§’å·²å›ºå®šï¼Œè«‹é–‹å§‹äº’å‹•");
            } else {
                btn.innerHTML = 'ğŸ”“ é–å®šè¦–è§’';
                btn.classList.remove('locked');
            }
        }

        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('show');
        }

        function createGhostHand() {
            const texture = createEmojiTexture('âœ‹');
            const geometry = new THREE.PlaneGeometry(0.5, 0.5);
            const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, opacity: 0.8, depthTest: false, side: THREE.DoubleSide });
            ghostHand = new THREE.Mesh(geometry, material);
            ghostHand.renderOrder = 999;
            scene.add(ghostHand);
            ghostHand.visible = false;
        }

        function createEmojiTexture(emoji) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = '100px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(emoji, 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        function createInteractable(pos, icon, type, isHidden = false) {
            const group = new THREE.Group();
            group.position.set(pos.x + model.position.x, pos.y + model.position.y + 0.1, pos.z + model.position.z);

            const iconMesh = new THREE.Mesh(
                new THREE.PlaneGeometry(0.4, 0.4),
                new THREE.MeshBasicMaterial({ map: createEmojiTexture(icon), transparent: true, depthTest: false })
            );
            iconMesh.userData = { isIcon: true };
            
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(0.18, 0.22, 32),
                new THREE.MeshBasicMaterial({ color: 0x667eea, side: THREE.DoubleSide, transparent: true, opacity: 0.6, depthTest: false })
            );
            
            const hitBox = new THREE.Mesh(
                new THREE.SphereGeometry(0.4, 8, 8), 
                new THREE.MeshBasicMaterial({ visible: false }) 
            );
            hitBox.userData = { isHitBox: true, type: type };

            group.add(iconMesh);
            group.add(ring);
            group.add(hitBox);
            
            if (isHidden) group.visible = false;

            scene.add(group);
            interactables.push(group);

            gsap.to(iconMesh.scale, { x: 1.2, y: 1.2, duration: 0.8, yoyo: true, repeat: -1 });
            
            if (icon === 'ğŸ§–â€â™€ï¸') {
                gsap.to(group.position, { y: group.position.y + 0.15, duration: 1, yoyo: true, repeat: -1, ease: "power1.inOut" });
            }

            group.tick = () => {
                iconMesh.lookAt(camera.position);
                ring.lookAt(camera.position);
            };

            return group;
        }

        function setPhase(p) {
            currentPhase = p;
            currentStepIndex = 0;
            document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('p'+p).classList.add('active');
            
            const btnText = document.getElementById('p'+p).innerText;
            if(document.getElementById('phase-title')) {
                document.getElementById('phase-title').innerText = btnText;
            }
            setupStep();
        }

        function setupStep() {
            interactables.forEach(obj => scene.remove(obj));
            interactables = [];
            if(tweenAnim) tweenAnim.kill();
            ghostHand.visible = false;

            const step = learningData[currentPhase][currentStepIndex];
            document.getElementById('step-num').innerText = step.id;
            document.getElementById('action-text').innerText = step.text;
            document.getElementById('action-note').innerText = step.note;
            document.getElementById('current-tool-icon').innerText = step.icon;

            if (step.type === 'drag') {
                const startObj = createInteractable(step.start, 'ğŸŸ¢', 'start');
                startObj.userData.isStart = true;
                const endObj = createInteractable(step.end, 'ğŸ', 'end', true);
                endObj.userData.isEnd = true;
                showGhostGuide(step.start, step.end, true);
            } else {
                createInteractable(step.pos, step.icon, 'click');
                showGhostGuide(step.pos, step.pos, false);
            }
        }

        function showGhostGuide(startRel, endRel, isMove) {
            ghostHand.visible = true;
            ghostHand.material.opacity = 0.8;
            const start = { x: startRel.x + model.position.x, y: startRel.y + model.position.y + 0.2, z: startRel.z + model.position.z };
            
            if (isMove) {
                const end = { x: endRel.x + model.position.x, y: endRel.y + model.position.y + 0.2, z: endRel.z + model.position.z };
                ghostHand.position.set(start.x, start.y, start.z);
                tweenAnim = gsap.timeline({repeat: -1, repeatDelay: 1});
                tweenAnim.to(ghostHand.position, { x: end.x, y: end.y, z: end.z, duration: 1.5, ease: "power2.inOut" })
                         .to(ghostHand.material, { opacity: 0, duration: 0.5 });
            } else {
                ghostHand.position.set(start.x, start.y + 0.2, start.z);
                tweenAnim = gsap.to(ghostHand.position, { y: start.y, duration: 0.8, yoyo: true, repeat: -1 });
            }
        }

        function onTouchStart(e) { e.preventDefault(); onPointerDown(e.touches[0]); }
        function onTouchMove(e) { e.preventDefault(); onPointerMove(e.touches[0]); }

        function onPointerDown(e) {
            updateMouse(e);
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactables, true);

            if (intersects.length > 0) {
                let targetGroup = intersects[0].object;
                while(targetGroup.parent && targetGroup.parent.type !== 'Scene') {
                    targetGroup = targetGroup.parent;
                }

                const step = learningData[currentPhase][currentStepIndex];

                if (step.type === 'drag' && targetGroup.userData.isStart) {
                    isDragging = true;
                    controls.enabled = false;
                    ghostHand.visible = false; 
                    const endObj = interactables.find(obj => obj.userData.isEnd);
                    if(endObj) endObj.visible = true;
                    showHint(e.clientX, e.clientY, "æ»‘å‹•è‡³çµ‚é» ğŸ");
                } 
                else if (step.type === 'press' || step.type === 'click') {
                    gsap.to(targetGroup.scale, {x: 1.5, y:1.5, z:1.5, duration: 0.2, yoyo: true, repeat: 1});
                    showHint(e.clientX, e.clientY, "å®Œæˆï¼âœ¨");
                    setTimeout(nextStep, 500);
                }
            }
        }

        function onPointerMove(e) {
            updateMouse(e);
            const hint = document.getElementById('gesture-hint');
            if(hint.style.opacity == 1) {
                hint.style.left = e.clientX + 'px';
                hint.style.top = (e.clientY - 30) + 'px';
            }

            if (isDragging) {
                raycaster.setFromCamera(mouse, camera);
                const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -model.position.y);
                const point = new THREE.Vector3();
                raycaster.ray.intersectPlane(plane, point);
                
                if (point) {
                    ghostHand.visible = true;
                    ghostHand.position.copy(point);
                    ghostHand.position.y += 0.2;
                    
                    const step = learningData[currentPhase][currentStepIndex];
                    const endPos = new THREE.Vector3(step.end.x + model.position.x, step.end.y + model.position.y, step.end.z + model.position.z);
                    
                    if (ghostHand.position.distanceTo(endPos) < 0.4) {
                        isDragging = false;
                        if (!isCameraLocked) controls.enabled = true;
                        showHint(e.clientX, e.clientY, "å®Œç¾ï¼ğŸ‰");
                        setTimeout(nextStep, 500);
                    }
                }
            }
        }

        function onPointerUp() {
            if (isDragging) {
                isDragging = false;
                if (!isCameraLocked) controls.enabled = true;
                ghostHand.visible = false;
                document.getElementById('gesture-hint').style.opacity = 0;
                
                const endObj = interactables.find(obj => obj.userData.isEnd);
                if(endObj) endObj.visible = false;
                
                const step = learningData[currentPhase][currentStepIndex];
                showGhostGuide(step.start, step.end, true);
            }
        }

        function nextStep() {
            const list = learningData[currentPhase];
            if (currentStepIndex < list.length - 1) {
                currentStepIndex++;
                setupStep();
            } else {
                alert(`ğŸ‰ éšæ®µ ${currentPhase} å®Œæˆï¼`);
                if (learningData[currentPhase + 1]) setPhase(currentPhase + 1);
                else alert("æ­å–œå®Œæˆæ‰€æœ‰ç™‚ç¨‹ï¼");
            }
        }
        function prevStep() { if (currentStepIndex > 0) { currentStepIndex--; setupStep(); } }
        function forceComplete() { nextStep(); }
        function updateMouse(e) { mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; }
        function showHint(x, y, msg) {
            const el = document.getElementById('gesture-hint');
            el.innerText = msg; el.style.left = x + 'px'; el.style.top = (y - 30) + 'px'; el.style.opacity = 1;
            if(msg.includes("å®Œæˆ") || msg.includes("å®Œç¾")) setTimeout(() => el.style.opacity = 0, 1000);
        }
        function resetCam() { controls.reset(); }
        function toggleModel() { loadModel(activeModelType === 'male' ? 'female' : 'male'); }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
    </script>
</body>
</html>
